---
title: "Critical slowing down anticipates emergence and elimination of measles"
author:
  - name: "Andrew T. Tredennick"
    affiliation: UGA,CEID
    footnote: Corresponding Author
    email: atredenn@gmail.com
  - name: "Eamon O'Dea"
    affiliation: UGA,CEID
  - name: "TBD"
    affiliation: other
  - name: "Pejman Rohani"
    affiliation: UGA,CEID,ID
  - name: "John M. Drake"
    affiliation: UGA,CEID
    email: jdrake@uga.edu
address:
  - code: UGA
    address: "Odum School of Ecology, University of Georgia, Athens, GA 30602, USA"
  - code: CEID
    address: "Center for the Ecology of Infectious Diseases, University of Georgia, Athens, GA 30602, USA"
  - code: other
    address: "A University of Somewhere"
  - code: ID
    address: "Department of Infectious Diseases, University of Georgia, Athens, GA 30602, USA"
abstract: |
  Forecasts of the emergence, re-emergence, and elimination of human infectious diseases would allow for proactive, rather than reactive, decisions that could save lives. Recent theory suggests that a generic feature of dynamical systems approaching a tipping point -- critical slowing down -- can anticipate disease emergence and elimination. Empirical demonstrations of critical slowing down in real disease dynamics are scarce, but are essential before we can implement model-independent outbreak detection systems. Here, we use empirically-based, mechanistic models of measles transmission in four Nigerien cities to detect critical slowing down through statistical early warning signals. We find that several early warning signals accurately anticipate measles re-emergence and elimination, suggesting that critical slowing down can be detected before tipping points in real disease dynamics. Broadly, our findings suggest that early warning signals, coupled with decision-support algorithms and expert judgment, could provide the basis for outbreak early detection systems.
keywords:
  - critical slowing down,
  - early warning signals,
  - epidemiology,
  - measles,
  - infectious disease
bibliography: /Users/atredenn/Dropbox/Bibliography/measles-ews.bib
date: "`r Sys.Date()`"
csl: science-without-titles.csl
output: rticles::elsevier_article
layout: 3p # review # review = doublespace, 3p = singlespace, 5p = two-column
preamble: |
  \journal{Journal Name}
  \usepackage{lineno}
  \linenumbers
  \usepackage{mathptmx}
  \renewcommand{\theaffn}{\arabic{affn}}
extra: \usepackage[nomarkers]{endfloat}
---

```{r libraries, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE, cache = FALSE)
library(tidyverse)
library(ggthemes)
library(ggrepel)
library(cowplot)
library(pomp)
library(sf)
```

```{r load-data, include = FALSE}
## Fig 1A
region_boundaries <- st_read("../data/spatial-data/NER_adm2.shp")
mycoords <- as_tibble(st_coordinates(region_boundaries)) %>%
  group_by(L3) %>%
  summarise(minx = min(X)) %>%
  mutate(
    NAME_2 = region_boundaries$NAME_2
  )

region_boundaries <- region_boundaries %>%
  left_join(mycoords)

my_cities <- tibble(
  city = c("Agadez", "Maradi", "Niamey", "Zinder"),
  lat = c(16.9, 13.5, 13.5, 13.8),
  lon = c(8.0, 7.1, 2.1, 8.98),
  population = c("(118,244)", "(267,249)", "(1,027,000)", "(322,935)")
) %>%
  mutate(
    label = paste(city, population, sep = "\n")
  )

## Fig 1B
measles_file <- "../data/clean-data/weekly-measles-incidence-niger-cities-clean.RDS"
measles_data <- readRDS(measles_file) %>%
  filter(year > 1994) %>%
  dplyr::select(-year, -week_of_year, -obs_week, -time) %>%
  mutate(
    region = str_sub(region, 1, str_length(region)-7)  # remove (City) from name
  )
pred_ids <- grep("predictive-dist-states", list.files("../results/"))
pred_files <- list.files("../results/")[pred_ids]
pred_cases <- tibble()
for(do_file in pred_files){
  do_city <- str_split(do_file, "-")[[1]][4]
  do_city <- str_split(do_city, "[.]")[[1]][1]
  
  tmp_data <- measles_data %>%
    filter(region == do_city)
  
  tmp <- readRDS(paste0("../results/", do_file)) %>%
    unnest() %>%
    slice(2:n()) %>%  # drop first row of unobserved data
    mutate(
      upper_est = mean_cases + sdev_cases*2,
      lower_est = mean_cases - sdev_cases*2,
      lower_est = ifelse(lower_est < 0, 0, lower_est),
      city_name = do_city,
      date = tmp_data$date,
      observed_cases = tmp_data$cases
    )
  pred_cases <- bind_rows(pred_cases, tmp)
}
```


# Introduction

Forecasts of the emergence and re-emergence of infectious diseases have the potential to save lives, money, and human productivity by allowing for proactive, rather than reactive, preparedness measures [@Han2016].
Similarly, indicators of the elimination of infectious diseases can signal the effectiveness of ``end game'' strategies aimed at disease eradication [@Drake2017].
Predicting (re)emergence and elimination is possible with complex mathematical models of disease transmission, but their success relies on detailed understanding of the underlying transmission and pathogen dynamics.
We often do not have enough information to parameterize such models.
An alternative approach is to use model-independent statistical signals that portend infectious disease (re)emergence and elimination by detecting critical slowing down as the system approaches a critical transition [@ORegan2013].

Emergence and elimination of an infectious disease both involve a critical transition (technically, a *transcritical bifurcation*).
The transition typically occurs at the critical point where the basic reproduction number ($R_0$, the number of secondary cases that arise from a single infected case in a fully susceptible population) is equal to one [@Heffernan2005].
Thus, subcritical ($R_0 < 1$) and supercritical ($R_0 > 1$) systems represent alternative modes of fluctuation [@Scheffer2009; @Scheffer2012; @ORegan2013].

Critical transitions in stochastic systems, such as systems of disease transmission, are often associated with critical slowing down, a reduction in the resilience of a system to perturbations [@VanNes2007].
Critical slowing down (CSD), in turn, is associated with changes in the dynamical features of the system: early warning signals (EWS) such as an increase in the variance and autocorrelation [@Carpenter2006; @Scheffer2009].
Recent theoretical work suggests that CSD occurs as disease dynamics approach $R_0 = 1$ from below (emergence) [@ORegan2013; @Dibble2016] and from above (elimination) [@ORegan2013; @ORegan2016; @Drake2017], and that several EWS anticipate the critical transition [@Brett2017; @Brett2018; @Miller2017].
Empirical tests of EWS and associated CSD are, however, scarce.
Documenting CSD in real disease dynamics is an essential first step toward the development of model-independent outbreak detection systems [@Han2016].

Here, we use empirically-based model simulations of measles dynamics to test whether CSD anticipates critical transitions in real disease dynamics.
We focus on two scenarios: the re-emergence of measles following a large outbreak, a situation typical of measles dynamics in sub-Saharan Africa [@Ferrari2008], and the elimination of measles by a vaccination campaign.
We seek to answer two related questions.
First, can CSD distinguish between time series of disease incidence when the underlying dynamics are far from and near to a critical transition?
If so, then CSD can anticipate disease re-emergence and elimination.
Second, how does the distance to and the rate of approaching the threshold impact the anticipatory skill of CSD?

To answer these questions, we fit mechanistic models of disease transmission to time series of measles incidence in four Nigerien cities.
We then use the fitted models to perform model experiments designed to test the performance of several EWS, which quantify CSD, at anticipating re-emergence and elimination.
Our results confirm theoretical expectations about several EWS and associated CSD.
In particular, we show that CSD before a critical transition is detectable by several EWS in realistic scenarios, and they do so using much shorter time series than used in theoretical studies.
However, our study highlights the limitations of EWS in situations where disease re-emergence and elimination occurs rapidly.
Moreoever, and contrary to theoretical expectations [@ORegan2013], we find that EWS perform better at detecting CSD before re-emergence than before elimination.

# Materials and Methods

## Data
We used weekly measles case report data from four Nigerien cities: Agadez, Maradi, Niamey, and Zinder (Fig. \ref{data-plot}A).
The data were collected over an 11 year period from 1995-2005 (Fig. \ref{data-plot}B).
These data are ideal for testing theory on CSD in disease dynamics because each city has different population sizes, has different dynamics in terms of outbreak sizes and length of inter-epidemic periods, and each time series has different amounts of demographic stochasticity due to differences in population size.
Such differences provide a natural gradient of "noise" that may influence CSD [@Hastings2010; @Dakos2012a; @ODea2018a; @ORegan2018].
The data come from [*somewhere/someone*], and used here with permission from [*somewhere/someone*].

```{r data-plot, fig.width=8.5, fig.height=4, fig.cap="Locations of data sources and observed and predicted measles dynamics. (A) Locations and population sizes (in parantheses) of our four focal cities in Niger. (B) Time series of weekly reported cases (yellow solid lines) and the 95% prediction intervals (black ribbons) for one-week-ahead predictions from our fitted SEIR models for each city. \\label{data-plot}"}

set.seed(123478)
the_map <- ggplot(region_boundaries)+
  geom_sf(fill = "grey90", col = "grey80", size = 0.3) +
  geom_point(data = my_cities, aes(x = lon, y = lat), size = 2) +
  geom_label_repel(
    data = my_cities,
    aes(x = lon, y = lat, label = label),
    box.padding   = 0.35, 
    point.padding = 0.3,
    size = 2
  ) + 
  labs(x = "Longitude", y = "Latitude") +
  theme_minimal()

the_series <- ggplot(pred_cases, aes(x = date)) +
  geom_ribbon(aes(ymin = lower_est, ymax = upper_est), color = "black") +
  geom_line(aes(y = observed_cases), color = ptol_pal()(3)[2], size = 0.4) +
  facet_wrap(~city_name, scales = "free_y", ncol = 1) +
  labs(x = "Date", y = "Reported cases") +
  theme_minimal()

plot_grid(the_map, the_series, ncol = 2, labels = "AUTO", label_size = 12)
```

## Stochastic *SEIR* model
The model is a discrete-time approximation of a continuous-time SEIR model with limited demography, specified as a set of difference equations,

\begin{align}
S_{t+dt} &= n_{S,t} - n_{E,t} \\
E_{t+dt} &= n_{E,t} - n_{I,t} \\
I_{t+dt} &= n_{I,t} + n_{O,t} - n_{R,t},
\end{align}

\noindent{}where $\textbf{n}_t$ are random variables representing the number of individuals transitioning into or out of each class at each timestep $t \rightarrow t+dt$.
$n_{S}$ is the number of births, $n_{E}$ is the number of newly infected individuals that have the disease but are not infectious, $n_{I}$ is the number of newly infectious indiviuals, $n_{O}$ is the number of imported infections, and $n_{R}$ is the number of newly recovered individuals who are no longer infectious and have life-long immunity.
The stochastic random variables are specified as follows:

\begin{align}
n_{S,t} &\sim \text{Poisson}(\mu_t N_t \times dt) \\
n_{E,t} &\sim \text{Binomial}(\lambda_{E,t}, S_{t}) \\
n_{I,t} &\sim \text{Binomial}(\lambda_{I,t}, E_{t}) \\
n_{O,t} &\sim \text{Poisson}(\psi \times dt) \\
n_{R,t} &\sim \text{Binomial}(\lambda_{R,t}, I_{t}),
\end{align}

\noindent{}where $\mu_t$ is the birth rate at time *t*, $\psi$ is the rate of imported infections, and $\lambda_E$, $\lambda_I$, and $\lambda_R$ are the probabilities of exposure, becoming infectious, and recovery, respectively.
These probabilities reflect the processes of tranmission, transition from the latent period to the infectious period, and recovery, which we model as:

\begin{align}
\lambda_{E,t} &= 1 - e^{-\frac{\beta_t I_t dt}{N_t}} \\
\lambda_{I,t} &= 1 - e^{-\eta E_{t} dt} \\
\lambda_{R,t} &= 1 - e^{-\gamma I_{t} dt},
\end{align}

\noindent{}where $\beta_t$ is time-varying rate of transmission, $\eta$ is time-invariant rate from the exposed class to the infectious class, and $\gamma$ is time-invariant recovery rate.
We model rate of transmission as:

\begin{equation}
\beta_t = \beta \left(1 + \sum^6_{i=1} q_i \xi_{i_{t}} \right) \Gamma_t.
\end{equation}

$\beta$ is the mean transmission rate, $\psi$ accounts for measles infections from external sources that are not part of the local dynamics, and the term $\sum^6_{i=1} q_i \xi_{i_{t}}$ is a B-spline to model seasonality in transmission.
The B-spline bases ($\xi_{i_{t}}$) are periodic with a 1 year period.
The transmission rate ($\beta_t$) is also subject to stochastic process noise at each time step, $\Gamma_t$, which we model as gamma-distributed white (temporally uncorrelated) noise with mean 1 and variance $\sigma^2$ [@Breto2011].

We do not include a death process in the model because the rate of infection is much faster than the rate of death.
Excluding deaths means we can avoid making further assumptions about demographic rates -- we are already making assumptions about birth rates (e.g., the rate is the same across cities, but with city-specific population size).
We model demographic stochasticity in births and imported infections by drawing time-specific values from Poisson distributions.
In this model, the effective reproduction number at time *t* is: $R_E(t) = \frac{\beta_t}{\gamma} \frac{S_t}{N_t}$.

We assume observed case reports ($\textbf{y}$) are drawn from a Negative Binomial distribution subject to a constant reporting fraction ($\rho$) and dispersion parameter $\tau$,

\begin{align}
y_t \sim \text{Negative Binomial} \left( \rho I_t, \tau \right).
\end{align}

##  Model fitting and inference

We fit the SEIR model to time series of case reports from each of our focal cities using Maximization by Iterated particle Filtering (MIF).
We estimated 14 parameters for each city: six seasonal transmission parameters ($q_i$), mean transmission rate ($\beta$), three initial conditions $\left(S_{(t=0)},E_{(t=0)},I_{(t=0)}\right)$, the number of imported infections ($\psi$), reporting fraction ($\rho$), one parameter accounting for process noise ($\sigma$), and one parameter accounting for measurement noise ($\tau$).
To ensure identifiability, and to make the model easier to fit, we assumed the infectious period was fixed at $1/\eta = 8$ days and the recovery period was fixed at $1/\gamma = 5$ days.
The birth rate ($\mu_t$) was multiplied by 0.3 to account for the reported 70\% vaccination coverage [@Ferrari2008].

MIF relies on particle filtering, which estimates the likelihood of fixed parameters by integrating state variables of a stochastic system.
To narrow in on the maximum likelihood estimates, MIF lets parameters take a random walk during the filtering process and selectively propagates forward parameter sets (i.e., particles) with the highest likelihood.
The variance of the random walk decreases at each iteration of MIF, where a MIF iteration means one filtering pass through the time series.
This procedure converges toward the maximimum likelihood estimates (MLEs), in theory.

We used the IF2 algorithm [@Ionides2015] implemented in the R [@R2017] package `pomp` [@King2016; @King2018] to conduct the MIF procedure.
To initialize MIF, we generated 5000 parameter sets using Latin Hypercube Sampling over large ranges of the parameter values.
We then performed two rounds of MIF, each for 100 iterations, with 10000 particles, and geometric cooling.
For the first round of MIF we set `cooling.facter = 1`.
For the second round, which was initialized using the collection of parameter sets from the end of the first round, we set `cooling.factor = 0.9`.
We computed the log likelihood of 5000 final MIF parameter sets (i.e., parameter sets collected after 200 MIF iterations) as the log of the mean likelihoods of 50 replicate particle filters with 10000 particles each.
At this stage, we assume the parameter set with highest log likelihood is the MLE.

We used a bootstrapping approach to estimate approximate 95\% confidence intervals for all parameters.
The procedure, which was conducted for each city independently, is as follows.
First, we simulated 100 realizations from the fitted model using the MLE parameters.
Second, we fitted the SEIR model to each of the 100 bootstrap simulations using the same MIF procedure described above, except we initiated the parameter search from 50 parameter sets rather then 5000.
We reduced the number of parameter sets due to the computational constraints of fitting 100 simulated data sets for each of the four cities.
Third, we identified the MLE parameter set for each of the 100 bootstrap simulations from among the 50 MIF paramete sets.
Last, we calculated summary statistics (mean, median, quantiles) from the distribution of 100 MLE parameters (SI text).

## Model simulations

### Model-data comparisons
We used the MLE parameter sets to make one-week-ahead predictions and to test the ability of early warning signals to anticipate the critical transition at $R_E(t) = 1$.
To make one-week-ahead predictions, we used particle filtering with 50000 particles and retained the mean and standard deviation of all latent states across all particles before they were filtered at each time step.
We used the mean predictions ($\mathbb{E}(\text{cases}_t)$) to assess model fit using a generalized coefficient of determination, calculated as: $R^2 = 1 - \frac{\sum_t [\mathbb{E}(\text{cases}_t) - \text{cases}_t]^2}{\sum_t [\text{mean(cases)}-\text{cases}_t]^2}$ [@Martinez-Bakker2015].
<!-- To estimate a trend in tranmission rate, we allowed mean transmission to take a random walk throughout the filter and retained the filtered distribution of particles for mean transmission and $R_E(t$). -->

### Simulating re-emergence
To simulate re-emergence of measles, we manipulated the initial size of the susceptible pool to simulate an increase from low $R_E(t)$ to high $R_E(t)$.
Doing so allows us to test whether EWS can distinguish between windows of time when $R_E(t)$ is far from a critical transition and when $R_E(t)$ is near a critical transition.
We reduced the initial fraction of susceptible individuals by multplying the MLE for $S_{(t=0)}$ by six discounting factors: 1e-4, 0.1, 0.2, 0.3, 0.4, and 0.5.
These discounting factors represent situations of susceptible depletion after outbreaks of various size.
We then simulated the model forward for forty years using mean birth rate for the entire country ($\mu = 0.05$) and setting the death rate equal to the birth rate ($\mu = \nu = 0.05$) to achieve a constant total population size over the course of the simulation.
Forty years was long enough for $R_E(t)$ to reach or exceed 1 for each city.
Because the model is stochastic, we repeated these simulations 500 times for each city-susceptible discount combination.

Next, we split each simulated time series into null and test intervals.
First, across all simulations for a city-susceptible discount combination, we found the simulation year in which $R_E(t)$ reaches or exceeds 1 and excluded years past that year (SI text).
We split the remaining time series into two windows of equal length (Fig. S2).
The null interval is the first window, where $R_E(t)$ is increasing but far from 1.
The test interval is the second window, where $R_E(t)$ is increasing and approaching 1.
We did this for each city and for each level of susceptible depletion.
We calculated EWS over null and test intervals separately.

### Simulating elimination
To simulate elimination, we simulated a vaccine campaign in which vaccination coverage linearly increased over time to eventually reach 100\%, i.e. eradication (Fig. S3).
We ran simulations for 100 years, starting with 50 years of dynamics at the baseline vaccine coverage reported for Niger of 70\%, $p = 0.7$ [@Ferrari2008].
Note that vaccination coverage is included in our model by discounting the birth rate of susceptibles by $1-p$.
At year 50, we initiated the vaccination campaign and let the model run for another 50 years.
We ran simulations across six vaccination ``speeds'' (the rate at which $p \rightarrow 1$; SI text), simulating situations of slow and fast approaches to elimination.
As in the re-emergence simulations, we set the birth rate equal to the death rate to achieve a constant total population size. 

We then split each time series into null and test intervals for calculating EWS.
We define the test interval as the window of time between the start of the vaccination campaign (year 50) and the time at which vaccination coverage reached the vaccination threshold of $1 - 1/R_0$.
$R_0$ was calculated for each city using the MLE parameters (SI text).
We define the null interval as the window of time that ends at the start of the vaccination campaign (year 49) and starts at a time that results in an interval equal in length the test interval (Fig. S3).
EWS were then calculated for each interval.

## Early warning signals

We considered nine candidate early warning signals (Table S1).
We used the `spaero::get_stats()` function [@ODea2018] in R [@R2017] to calculate EWS according to the formulas in Table S1.
All EWS except the coefficient of variation are expected to increase as $R_E(t)$ approaches 1 from below [@ORegan2013; @ORegan2016; @Brett2018].
Less is known about the behavior of EWS as $R_E(t)$ approaches 1 from above.
But, theory does tell us that, for SIR models, the mean should decrease, autocorrelation should increase, and the variance should decrease [@ORegan2013].

For each simulation of re-emergence and elimination, we calculated EWS for the time series of expected cases in the null and test intervals.
This yielded a distribution of EWS over the 500 null and test intervals.
We assessed the performance of each EWS using the Area Under the Curve (AUC) statistic.
Specifically, we use AUC to calculate the amount of overlap between the distributions of each EWS from the null and test intervals.
Higher values of AUC indicate a greater degree of separation and thus better performance of a particular EWS in terms of classifying whether $R_E(t)$ is close to a critical transition.
We used the `pROC::auc()` function [@Robin2011] in R to calculate AUC values.


# Results

The fitted models adequately reproduce observed dynamics (Fig. \ref{data-plot}B), with in-sample $R^2$s from one-week-ahead predictions ranging from 0.54 for Agadez to 0.89 for Maradi (Fig. \ref{scatters}A).
Stochastic simulations of the models displayed dynamics typical of each city (Fig. S1), including the decline in seasonality amplitude as population size decreases (Fig. \ref{scatters}B) [@Ferrari2008].
Our model for Agadez performs poorly relative to the other cities.
Maximum likelihood estimates and bootstrapped 95% confidence intervals for all parameters are in the SI text.

```{r scatters-r0, fig.width=8.5, fig.height=4, fig.cap="Accuracy of the fitted *SEIR* models and estimated seasonality. (A) Comparison of in-sample model predictions and observations for each city. Expected cases are one-week-ahead predictions from the fitted models. The dashed line shows 1:1. Coefficients of determination ($R^2$) were calculated as the reduction in the sum-of-squared errors from model predictions relative to a null model of the mean number of cases (SI text). (B) The estimated seasonality of the basic reproductive ratio ($R_0$) for each city. $R_0$ was calculated as: $\\frac{\\eta \\beta_t \\mu}{\\nu(\\eta+\\nu)(\\gamma+\\nu)}$, where $1/\\eta$ is the infectious period, $1/\\gamma$ is the recovery period, $\\beta_t$ is the time-specific rate of transmission, $\\mu$ is the birth rate, and $\\nu$ is the death rate. Only $\\beta_t$ is estimated by our model. We set $1/\\eta$ = 8 days, $1/\\gamma$ = 5 days, and $\\mu = \\nu$ = 0.05 for calculating $R_0$ as shown in this figure. The white line is $R_0$ calculated using the MLE parameters; shaded regions are the bootstrapped 95% confidence intervals. \\label{scatters}"}
r_squares <- pred_cases %>%
  group_by(city_name) %>%
  mutate(
    mean_observations = mean(observed_cases),
    error_numer = (mean_cases - observed_cases)^2,
    error_denom = (mean_observations - observed_cases)^2
  ) %>%
  summarise(
    summed_numer = sum(error_numer),
    summed_denom = sum(error_denom)
  ) %>%
  mutate(
    R2 = 1 - (summed_numer / summed_denom)
  ) %>%
  dplyr::select(city_name, R2)

scatters <- ggplot(pred_cases, aes(x = log(observed_cases+1), y = log(mean_cases+1))) +
  geom_point(aes(color = city_name), size = 1, alpha = 0.3) +
  geom_abline(aes(intercept = 0, slope = 1), linetype = 2) +
  geom_label(data = r_squares, 
             aes(x = 1.7, y = 7.3, label = paste0("italic(R)^2 == ", 
                                                  round(R2,2))), 
             label.size = NA, parse = TRUE, size = 3) +
  labs(y = "Expected log(cases + 1)", x = "Observed log(cases + 1)") +
  facet_wrap(~city_name, nrow = 2, scales = "free") +
  scale_y_continuous(limits = c(0,8)) +
  scale_x_continuous(limits = c(0,8)) +
  scale_color_colorblind()+
  guides(color = FALSE)+
  theme_classic(base_size = 10) +
  theme(panel.spacing = unit(1, "lines"), strip.background = element_blank(),
        strip.text = element_text(face = "bold"),
        plot.title = element_text(face = "bold")) +
  ggtitle("A. Model-data agreement")

calc_R0 <- function(beta = NULL, B = NULL, qis = NULL, season = NULL, 
                    eta = (365/8), mu = 0.05, nu = 0.05, gamma = (365/5)){
  if(is.null(beta)){
    R0 <- (eta*B*mu) / (nu*(eta + nu)*(gamma + nu))
  } else{
    B <- as.numeric((1 + exp(season %*% qis)) * beta)
    R0 <- (eta*B*mu) / (nu*(eta + nu)*(gamma + nu))
  }
  return(R0)
}

# Define computation grid for bootstraps

nboots <- 100
nmifs <- 50
comp_grid <- expand.grid(1:nboots, 1:50)
colnames(comp_grid) <- c("boot_series", "param_set")
comp_grid$do_grid <- 1:nrow(comp_grid)

# Load example pomp file for basis function
pomp_file <- "../code/measles-pomp-object-Agadez.RDS"
measles_pomp <- readRDS(pomp_file)  # exemplar bases

bases <- as_tibble(measles_pomp@covar) %>%
  dplyr::select(starts_with("x")) %>%
  dplyr::slice(1:365) %>%
  mutate(
    day = 1:365
  ) %>%
  gather(key = base, value = value, -day)

season <- bases %>%
  spread(key = base, value = value) %>%
  dplyr::select(-day) %>%
  as.matrix()

seasonal_functions <- tibble()
for(do_city in c("Agadez", "Maradi", "Niamey", "Zinder")){
  boots <- read.csv(paste0("../results/bootstrap-mif-lls-", do_city, ".csv"))
  
  b_splines <- boots %>%
    slice(2:n()) %>%  # ignore first row of NAs
    left_join(comp_grid, by = "do_grid") %>%  # merge in comp grid info
    group_by(boot_series) %>%
    filter(loglik == max(loglik)) %>%
    ungroup() %>%
    dplyr::select(b1, b2, b3, b4, b5, b6)
  
  betas <- boots %>%
    slice(2:n()) %>%  # ignore first row of NAs
    left_join(comp_grid, by = "do_grid") %>%  # merge in comp grid info
    group_by(boot_series) %>%
    filter(loglik == max(loglik)) %>%
    ungroup() %>%
    dplyr::select(beta_mu)
  
  seasonal_betas <- tibble()
  for(i in 1:nrow(b_splines)){
    qis <- as.numeric(b_splines[i, ])
    beta_tmp <- as.numeric(betas[i, "beta_mu"])
    
    seasonal_tmp <- tibble(
      beta = as.numeric((1+exp(season %*% qis)) * beta_tmp),
      day = 1:365,
      boot = i
    )
    seasonal_betas <- bind_rows(seasonal_betas, seasonal_tmp)
  }  # end bootstrap loop
  
  seasonal_betas <- seasonal_betas %>%
    mutate(
      city = do_city,
      rnaught = calc_R0(B = beta)
    ) %>%
    group_by(city, day) %>%
    summarise(
      upper_R0 = quantile(rnaught, 0.975),
      lower_R0 = quantile(rnaught, 0.025)
    ) %>%
    ungroup()
  
  seasonal_functions <- bind_rows(seasonal_functions, seasonal_betas)
  
}  # end city loop

seasonal_functions <- seasonal_functions %>%
  mutate(
    date = as.Date(day, origin = "2016-12-31",tz = "UTC")
  )

# Calculate MLE R0 curves for each city

R_0s <- tibble()

for(do_city in c("Agadez", "Maradi", "Niamey", "Zinder")){
  
  # Load fitted parameters and pomp model 
  mle_file <- paste0("../results/initial-mif-lls-", do_city, ".csv")
  
  mles <- read.csv(mle_file) %>% 
    slice(2:n()) %>%  # ignore first row of storage NAs
    filter(loglik == max(loglik, na.rm = TRUE)) %>%
    dplyr::select(-do_grid, -loglik, -loglik_se)
  
  pomp_file <- paste0("../code/measles-pomp-object-", do_city, ".RDS")
  fitted_pomp <- readRDS(pomp_file)
  
  # Calculte R0 
  qis <- mles %>%
    dplyr::select(b1, b2, b3, b4, b5, b6) %>%
    as.numeric()
  
  beta <- mles %>%
    pull(beta_mu)
  
  bases <- as_tibble(fitted_pomp@covar) %>%
    dplyr::select(starts_with("x")) %>%
    dplyr::slice(1:365) %>%
    mutate(
      day = 1:365
    ) %>%
    gather(key = base, value = value, -day)
  
  season <- bases %>%
    spread(key = base, value = value) %>%
    dplyr::select(-day) %>%
    as.matrix()
  
  N <- round(mean(fitted_pomp@covar[, "N"]))
  
  R0 <- calc_R0(beta = beta, qis = qis, season = season)
  
  tmp_out <- tibble(
    city = do_city,
    day = 1:length(R0),
    R0 = R0
  )
  
  R_0s <- bind_rows(R_0s, tmp_out)
}

R_0s <- R_0s %>%
  mutate(
    date = as.Date(day, origin = "2016-12-31",tz = "UTC")
  )

all_R_0s <- left_join(R_0s, seasonal_functions, by = c("city", "day", "date"))

rnaughts <- ggplot(all_R_0s, aes(x = date)) +
  geom_ribbon(aes(ymin = lower_R0, ymax = upper_R0, fill = city), alpha = 0.6) +
  geom_line(aes(y = R0), color = "white") +
  scale_fill_colorblind(name = NULL) +
  scale_color_colorblind(name = NULL) +
  guides(fill = FALSE) +
  facet_wrap(~city,nrow = 2, scales = "free") +
  labs(x = "Time of year", y = expression(italic(R[0]))) +
  scale_x_date(date_labels = "%b", date_breaks = "2 months") +
  scale_y_continuous(limits = c(0,35))+
  theme_classic(base_size = 10) +
  theme(panel.spacing = unit(1, "lines"), strip.background = element_blank(),
        strip.text = element_text(face = "bold"),
       plot.title = element_text(face = "bold")) +
  ggtitle("B. Seasonal basic reproduction number")

plot_grid(scatters, rnaughts, labels = NULL, scale = 0.9, label_size = 12)
```


```{r aucs, fig.width=8.5, fig.height=5.5, fig.cap="Performance of early warning signals (EWS) over fixed windows. EWS were calculated over two windows, one far from a critical transition and one near, for simulations of re-emergence (A) and elimination (B). EWS performance is quantified using the AUC metric, which we show here as a heatmap of AUC values minus 0.5. AUC values closer to 0.5 indicate higher ability to distinguish among time series near and far from a critical transition. The asterisks in (A) for Niamey note EWS with high AUC but for the wrong reason: skewness and kurtosis *decrease* as $R_E(t)$ approaches 1 rather than increase. This occurs because of the negative binomial sampling in the measurement component of our SEIR model [@Brett2018]. \\label{aucs}"}
library(viridis)

emergence_aucs <- read.csv("../results/emergence-grid-aucs.csv")
elimination_aucs <- read.csv("../results/elimination-grid-aucs.csv")

star_tbl <- tibble(
  city = "Niamey",
  x = as.factor(rep(1e-04, 2)),
  y = c(5.7, 7.7)
)

emerge_plot <- ggplot() +
  geom_tile(data = emergence_aucs, aes(x = as.factor(susc_discount), y = metric, fill = abs(AUC-0.5))) +
  geom_text(data = star_tbl, aes(x = x, y = y, label = "*"), color = "white", size = 6) +
  scale_fill_viridis(limits = c(0,0.5), direction = -1, option = "C", name = "| AUC - 0.5 |") +
  facet_wrap(~city, nrow = 1) +
  labs(x = "Level of susceptible depletion", y = NULL) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(panel.spacing = unit(1, "lines"),
        plot.title = element_text(size = 11, face = "bold")) +
  ggtitle("A. Anticipating emergence")

eliminate_plot <- ggplot() +
  geom_tile(data = elimination_aucs, aes(x = as.factor(vacc_speed*10000), y = metric, fill = abs(AUC-0.5))) +
  scale_fill_viridis(limits = c(0,0.5), direction = -1, option = "C", name = "| AUC - 0.5 |") +
  facet_wrap(~city, nrow = 1) +
  labs(x = expression(paste("Rate to full vaccine coverage (", phantom()%*%phantom(), 10^4, ")")), y = NULL) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(panel.spacing = unit(1, "lines"),
        plot.title = element_text(size = 11, face = "bold")) +
  ggtitle("B. Anticipating elimination")

cowplot::plot_grid(emerge_plot, eliminate_plot, nrow = 2, align = "v", labels = NULL, label_size = 12)
```

In the approach to re-emergence, the EWS generally perform as expected, with Niamey being an exception (Fig. \ref{aucs}A).
Skewness, kurtosis, and coefficient of variation performed poorly across all levels of susceptible depletion in all cities except Niamey.
For Niamey, it appears these metrics perform well at the highest levels of susceptible depletion (i.e., low discounting factors).
In fact, the high AUC values for Niamey result from exceptionally poor performance: they are all higher in the null interval rather than the test interval, contrary to theoretical expectations (Fig. S4).
Thus, these metrics are unreliable.

For the other cities, variance, mean, index of dispersion, decay time, autocovariance, and autocorrelation all perform equally well at predicting re-emergence (Fig. \ref{aucs}A).
Their performance declines as the amount of susceptible depletion decreases.
This is expected because more rapid returns to $R_E(t)=1$ result in shorter null and test intervals, making estimates of EWS less precise.
Likewise, as the total time to reach $R_E(t)=1$ decreases, the null and test intervals start to behave more similarly.
In part, this is because susceptible replenishment is linear in our model.
Nonlinear increases in the susceptible pool would lead to different dynamics.

The EWS did not perform as well when anticipating elimination, relative to emergence (Fig. \ref{aucs}B).
Only three metrics are reliable: mean, autocovariance, and variance.
All three metrics decreased as $R_E(t)$ approached the critical transition (Fig. S5).
As in the case of anticipating elimination, AUC values decreased as the speed of the vaccine campaign increased.
Again, this is due to shorter null and test intervals.

In all, the suite of EWS suggest that critical slowing down does occur in measles dynamics as a critical transition is approached.
We found similar results for the approach to elimination when calculating EWS over a moving window of 35 weeks in the null and test intervals (SI text, Fig. S7).
But, all EWS performed worse when predicting the approach to emergence over the moving window (Fig. S7).

A change in the variance of a dynamical system is one of the most well-studied early warning signals [@Scheffer2012], and it performed well here Fig. \ref{aucs}.
Thus, we show the distributions of the variance in the null and test intervals for each city as an example of the changes expected (Fig. \ref{var-ex}).
In many cases, the variance is expected to increase as a critical transition is approached [@Carpenter2006; @Dakos2012a; @ORegan2013], and we find this to be the case for re-emergence.
The variance decreases on the approach to elimination, which is counter to generic theory but in line with expectations specific to an SIR disease transmission model [@ORegan2013].

# Discussion

Using empirically-based disease transmission models, we found evidence of critical slowing down before critical transitions to re-emergence and elimination of measles.
This evidence comes from the fact that several EWS accurately anticipate the critical transition.

```{r susc-deplete, eval = FALSE}
# Define threshold for outbreak year --------------------------------------

# Outbreaks defined as: an annual case count exceeding x% of the maximum
# annual case count for a region, where x is the threshold set below.
outbreak_threshold <- 0.8  # 80% of max = outbreak year


# Load simulated data -----------------------------------------------------

cities <- c("Agadez", "Maradi", "Niamey", "Zinder")
sim_data <- tibble()
for(do_city in cities){
  tmp_file <- paste0("../simulations/bootstrap-sims-", do_city, ".RDS")
  tmp_data <- readRDS(tmp_file) %>%
    unnest() %>%
    mutate(city = do_city)
  sim_data <- bind_rows(sim_data, tmp_data)
}


# Identify outbreak years and calculate S depletion -----------------------

outbreak_years <- sim_data %>%
  mutate(year = trunc(time)) %>%
  group_by(city, sim, year) %>%
  summarise(total_cases = sum(reports),
            max_S = max(S),
            min_S = min(S)) %>%
  mutate(outbreak = ifelse(total_cases > outbreak_threshold*max(total_cases), 
                           TRUE, FALSE),
         max_S_t_minus_1 = lag(max_S),
         susc_depletion = min_S / max_S_t_minus_1) %>%
  filter(outbreak == TRUE) %>%
  drop_na()


# Calculate fraction of depletions less than 0.5 --------------------------

fracs_less_than_half <- outbreak_years %>%
  ungroup() %>%
  group_by(city) %>%
  mutate(
    deplete_half = ifelse(susc_depletion < 0.5, TRUE, FALSE)
  ) %>%
  group_by(city, deplete_half) %>%
  count() %>%
  group_by(city) %>%
  mutate(
    frac_less = n/sum(n)
  ) %>%
  filter(deplete_half == TRUE) %>%
  dplyr::select(city, frac_less)

percs <- fracs_less_than_half$frac_less*100
```


```{r var-ews, fig.width=4, fig.height=4, fig.cap="Boxplots of the variance in null (far from $R_E$ = 1) and test (close to $R_E$ = 1) intervals. As expected by theory, the variance decreases on the approach to elimination and the variance increases on the approach to emergence. Greater separation between the null and test distributions leads to higher AUC values in Fig. 3. Variance is log transformed for visual purposes. \\label{var-ex}"}
do_metric <- "variance"

emerge_ews <- read.csv("../results/ews-emergence.csv") %>%
  filter(metric == do_metric & susc_discount == 1e-04)  %>%
  mutate(
    metric = as.character(metric),
    metric = ifelse(metric == "variance", "Variance", metric),
    type = "Emerge."
  )

elimin_ews <- read.csv("../results/ews-elimination.csv") %>%
  filter(metric == do_metric & vacc_speed == 1.5e-05)  %>%
  mutate(
    metric = as.character(metric),
    metric = ifelse(metric == "variance", "Variance", metric),
    type = "Elimin."
  )

all_ews <- bind_rows(emerge_ews, elimin_ews)

mycols <- c("#91CDF0", "#EF6677")

ggplot(all_ews, aes(x = type, y = log(value), fill = half)) +
  geom_boxplot(outlier.size = 0.6, outlier.shape = 1, width = 0.5, lwd = 0.2) +
  facet_wrap(~city, scales = "free", nrow = 2) +
  scale_fill_manual(values = mycols, name = "Interval", labels = c("Null", "Test")) +
  labs(x = NULL, y = "log(Variance)") +
  theme_classic(base_size = 10) +
  theme(panel.spacing = unit(1, "lines"), strip.background = element_blank(),
        strip.text = element_text(face = "bold"),
        plot.title = element_text(face = "bold"))
```

# Acknowledgments
This research was funded by the National Institute of General Medical Sciences of the National Institutes of Health (Award Number U01GM110744).
The funders had no role in study design, data collection and analysis, decision to publish, or preparation of the manuscript.
This work was done on the Olympus High Performance Compute Cluster located at the Pittsburgh Supercomputing Center at Carnegie Mellon University, which is supported by National Institute of General Medical Sciences Modeling Infectious Disease Agent Study (MIDAS) Informatics Services Group grant 1U24GM110707.

# References
