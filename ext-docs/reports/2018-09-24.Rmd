---
title: "MIF Results — Round 2"
author: "Andrew Tredennick"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

## Overview

This is a report on the second round of results from fitting the stochastic SIR model to data from Niamey using iterated filtering (MIF), as implemented in `pomp::mif2()`.
The report also covers inital analyses that formally link EWS and rate of transmission.

## Methods

### Stochastic SIR model
The model is a continuous time *SIR* model with limited demography, specified as a set of stochastic differential equations:

\begin{align}
dS &= \mu_t N_t dt - \lambda_t S_t dt + dU_t \\
dI &= \psi_t dt + \lambda_t S_t dt - \gamma I_t dt + dV_t \\
dR &= \gamma I_t dt + dW_t,
\end{align}

\noindent{}where $\mu_t$ is birth rate at time *t*, $\gamma$ is the time-invariant recovery rate, $\psi_t$ is rate of imported infections, $\lambda_t$ is the time-varying force of infectionm, and $U_t$ and $V_t$ are noise terms.
We do not include a death process in the model because we expect death rates from the susceptible and infectious classes to be minimal relative to births.
Moreover, we do not explicitly model the recovered class (*R*) because $S(t)+I(t)+R(t) = N(t)$ and we have estimates of population size through time, $N(t)$.
We model stochasticity in births and imported infections by drawing time-specific values from Poisson distributions.
Transitions in the model are shown in Table \ref{table:model-trans}.
We model $\lambda_t$ as a function of a seasonal tranmission rate subject to additional environmental variability through time:

\begin{align}
\lambda_t &= \frac{\beta_t I_t}{N_t}, \\
\beta_t &= \beta \left(1 + \sum^6_{i=1} q_i \xi_{i_{t}} \right) \Gamma_t,
\end{align}

\noindent{}where $\beta_t$ is the rate of transmission at time *t*, $\beta$ is the mean transmission rate, $\psi$ accounts for measles infections from external sources that are not part of the local dynamics, and the term $\sum^6_{i=1} q_i \xi_{i_{t}}$ is a B-spline to model seasonality in transmission.
The B-spline bases ($\xi_{i_{t}}$) are periodic with a 1 year period.
The transmission rate ($\beta_t$) is also subject to stochastic process noise at each time step, $\Gamma_t$, which we model as a gamma-distributed white (temporally uncorrelated) noise with mean 1 and variance $\sigma^2$ (Bretó and Ionides 2011).
In this model, the effective reproductive ratio at time *t* is: $\mathcal{R}_{E(t)} = \beta_t / \gamma$.

We assume observed case reports ($\textbf{y}$) are drawn from a Poisson distribution subject to a constant reporting fraction ($\rho$),

\begin{align}
y_t \sim \text{Poisson} \left( \rho I_t \right).
\end{align}

| Transition | ($\Delta S$, $\Delta I$) | Propensity |
| --------------- | ------------ | -------------------------------------------- |
| birth | $(1, 0)$ | $N_t \mu$ |
| imported infections | $(0, 1)$ | $\psi_t$ |
| transmission (deterministic) | $(-1, 1)$ | $SI \beta_t / N_t$ |
| transmission (stochastic) | $(-k, k)$ | $\frac{S}{k}\sum^k_{j=0} \left(\begin{matrix}k\\j\end{matrix} \right) (-1)^{k-j+1} \tau_{\text{f}}^{-1} \text{ln}(1 + (\beta_tI/N_t)) \tau_{\text{f}} (S-j)$ |
| recovery | $(0, -1)$ | $I\gamma$ |

Table: Transitions in the SI model. We show the determinstic transmission rate for clarity, but our model uses the stochastic tranmission rate.

| Parameter | Description |
| --------- | ----------- |
| $\beta$ | Mean rate of transmission |
| $\rho$ | Constant reporting fraction |
| $q_i$ for $i \in \{1,2,3,4,5,6\}$ | B-spline coefficients for seasonality |
| $\psi$ | External infections |
| $\sigma^2$ | Variance of gamma-distributed environmental noise |
| $S_0$ | Initial conditions for susceptible class |
| $I_0$ | Initial conditions for infected class |

Table: Definitions of unknown parameters.

### Maximization by iterated filtering (MIF)
I started the analysis by making a Latin hypercube sample of parameter values (5000 parameter sets) that served as initial conditions for iterated filtering.
I ran `pomp::mif2()` for all 5000 initial conditions for 100 MIF itertations with 10000 particles and the cooling factor set to 1 (i.e., no cooling).
MIF iterations were then continued for another 100 iteration with 10000 particles with the cooling factor set to 0.95.
At the final iteration, I ran 20 replicate instances of `pomp::pfilter()` to estimate the log likelihood of the parameters for each of the 5000 MIF estimates and the Monte carlo error.

### Estimating time-varying rate of tranmission
To estimate the time-varying rate of tranmission, I ran a particle filter at the MLEs, but with a twist.
I allowed the mean rate of tranmission ($\beta$) to take a random walk with gamma distributed white noise: `beta_t *= rgammawn(0.001, dt)/dt;`, where `beta_t[1] = 31.5`.
I ran the particle filter woth 50000 particles and then used the filtering distribution to estimate the time course of transmission.

### Linking EWS and rate of transmission
I calculated 10 candidate EWS from the case incidence data using a 52 week bandwidth.
I then calculate the Spearman's rank correlation ($\rho$) between each EWS and estimated rate of transmission through time.
This resulted in p-values for significance of the correlation and a confidence interval around the point estimate of $\rho$.

## Results

### Traceplots of the iterated filtering paths for the parameter sets with the 200 highest log likelihoods
```{r traces, echo = FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(pomp)

mif_traces <- read_csv("../../results/mif-traces-200highest.csv")
mif_finals <- read_csv("../../results/initial-mif-lls.csv")

best_grids <- mif_finals %>%
  arrange(-loglik)

best_grids <- best_grids[1:200, ] %>%
  pull(do_grid)

# mif_traces_long <- mif_traces %>%
#   gather(key = parameter, value = value, -do_grid, -iteration) %>%
#   filter(do_grid %in% best_grids)

ggplot(mif_traces, aes(x = iteration, y = value, group = do_grid)) +
  geom_line(alpha = 0.1) +
  facet_wrap(~parameter, scales = "free_y")
```


### Parameter estimates with the highest log likelihood
Note that the model was fit with a time-step of 1 day (`delta.t = 1/365`).
```{r mles, echo = FALSE, warning=FALSE, message=FALSE}
mles <- mif_finals %>%
  filter(loglik == max(loglik, na.rm = TRUE)) %>%
  dplyr::select(-do_grid)

measles_pomp <- readRDS("../../code/measles-pomp-object.RDS")
population <- as_tibble(measles_pomp@covar)%>%
  dplyr::select(N) %>%
  slice(1) %>%
  pull(N)

knitr::kable(mles, digits = 2) 
```

Initial estimate of susceptible population is: `r round(mles$S_0*population)`.

### Model simulations at the (current) MLEs
```{r sims, echo = FALSE, warning=FALSE, message=FALSE}
mles <- mif_finals %>%
  filter(loglik == max(loglik, na.rm = TRUE)) %>%
  dplyr::select(-do_grid, -loglik, -loglik_se)

measles_pomp <- readRDS("../../code/measles-pomp-object.RDS")

simulate(
  measles_pomp,
  params = unlist(mles),
  nsim = 9,
  as.data.frame = TRUE,
  include.data = TRUE) %>%
  ggplot(aes(x = time, y = reports, group = sim, color = (sim == "data"))) +
  geom_line() +
  scale_color_manual(values = c(`TRUE` = "blue", `FALSE` = "red"))+
  guides(color = FALSE) +
  facet_wrap(~sim, ncol = 2) +
  scale_y_sqrt() +
  theme(strip.text=element_blank())

simulate(
  measles_pomp,
  params = unlist(mles),
  nsim = 9,
  as.data.frame = TRUE,
  include.data = FALSE) %>%
  ggplot(aes(x = time, y = S, group = sim, color = (sim == "data"))) +
  geom_line() +
  scale_color_manual(values = c(`TRUE` = "blue", `FALSE` = "red"))+
  guides(color = FALSE) +
  facet_wrap(~sim, ncol = 2) +
  scale_y_sqrt() +
  theme(strip.text=element_blank())
```

### Estimated rate of transmission
```{r beta-ts, echo = FALSE, warning=FALSE, message=FALSE}
ews_results <- readRDS("../../results/ews-niger-cities.RDS") %>%
  filter(city == "Niamey (City)")

beta_results <- read_csv("../../results/transmission-posteriors.csv", col_types = cols()) %>%
  dplyr::select(-week) %>%
  mutate(
    date = unique(ews_results$date)[2:length(unique(ews_results$date))]
  ) %>%
  dplyr::select(-time)

ggplot(beta_results, aes(x = date,  y = med)) +
  geom_ribbon(aes(ymax = upper, ymin = lower), alpha = 0.3) +
  geom_line() +
  labs(x = "Date", y = expression(paste("Rate of transmission, ", beta," (", yr^-1,")"))) +
  theme_minimal()

```

### Correlations between EWS and $\beta$
```{r betea-corrs, echo = FALSE, warning=FALSE, message=FALSE}
ews_results <- readRDS("../../results/ews-niger-cities.RDS") %>%
  filter(city == "Niamey (City)")

beta_results <- read_csv("../../results/transmission-posteriors.csv", col_types = cols()) %>%
  dplyr::select(time, med) %>%
  mutate(
    date = unique(ews_results$date)[2:length(unique(ews_results$date))]
  ) %>%
  dplyr::select(-time) %>%
  rename(beta_value = med) %>%
  filter(beta_value != max(beta_value, na.rm = TRUE))


scale_it <- function(x){
  (x - min(x, na.rm = TRUE))/(max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
}

ews_beta <- ews_results %>%
  left_join(beta_results, by = "date") %>%
  group_by(ews) %>%
  mutate(
    scaled_ews = scale_it(value),
    scaled_beta = scale_it(beta_value)
  )

library(DescTools)
library(ggthemes)

ews_beta_corrs <- ews_beta %>%
  group_by(ews) %>%
  summarise(
    spearman_value = SpearmanRho(value, beta_value, use = "pairwise.complete.obs",  conf.level = 0.95)[1],
    spearman_lwr = SpearmanRho(value, beta_value, use = "pairwise.complete.obs",  conf.level = 0.95)[2],
    spearman_upr = SpearmanRho(value, beta_value, use = "pairwise.complete.obs",  conf.level = 0.95)[3], 
    spearman_pvalue = cor.test(value, beta_value, use = "pairwise.complete.obs", method = "spearman")[["p.value"]]
  ) %>%
  mutate(
    pos = spearman_value > 0,
    sig = spearman_pvalue < 0.05,
    color_id_final = "cnull",
    color_id_final = ifelse(pos == TRUE & sig == TRUE, "apos", color_id_final),
    color_id_final = ifelse(pos == FALSE & sig == TRUE, "bneg", color_id_final)
  )

ggplot(ews_beta_corrs, aes(x = ews, y = spearman_value, color = color_id_final)) +
  geom_hline(aes(yintercept = 0), linetype = 2) +
  geom_errorbar(aes(ymin = spearman_lwr, ymax = spearman_upr), width = 0.1) +
  geom_point() +
  scale_color_manual(values = c("blue", "grey35"), guide = FALSE) +
  labs(y = expression(paste("Spearman's ", rho)), x = "Early warning signal") +
  theme_minimal() +
  coord_flip()

ggplot(ews_beta, aes(x = date)) +
  geom_line(aes(y = scaled_ews, color = "EWS")) +
  geom_line(aes(y = scaled_beta, color = "beta")) +
  facet_wrap(~ews) +
  labs(x = "Date", y = "Early warning signal\nor\nTransmission rate") +
  scale_color_manual(values = ptol_pal()(2), labels = c(expression(paste(beta,"     ")), "EWS"), name = NULL) +
  theme_minimal() +
  theme(legend.position = "top")
```
