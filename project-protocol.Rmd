---
title: 'PROTOCOL FOR:'
subtitle: Linking early warning signals to the temporal epidemiology of measles in
  Nigerian cities
author: "Andrew Tredennick (atredenn@gmail.com)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(tidyverse)
library(ggthemes)
library(pomp)
library(lubridate)
library(mvtnorm)

theme_set(theme_minimal())
```

## Authors
+ Andrew Tredennick
+ Eamon O'Dea
+ Pejman Rohani
+ John Drake


## Background
Theory shows that epidemic transitions can be anticipated by trends in the statistical properties of disease time series (AERO papers).
The existence of statistical trends in the data that precede critical transitions, so-called 'early warning signals' (EWS), imply that we may be able to anticipate disease emergence and outbreaks.
The end goal is a model-independent detection system, where statistical properties of disease surveilence data can trigger warnings of impending outbreaks without the need to fit mechanistic models of disease transmission (Han and Drake 2017).

However, there is currently a gap between the theoretical work, which has relied on knowing the underlying disease dynamics, and the eventual goal of applying EWS in real-world situations where the underlying disease dynamics may be unknown.
[What is the gap?] *Without knowing whether EWS actually track or anticipate undelrying dynamics of real disease time series, we don't know if we are getting the right answer for the wrong reason.*
[How will this study fill the gap?]
To bridge this gap we will fit a mechanistic model to incidence data of measles in Niger to estimate the temporal epidemiology of the disease, yielding the very same parameters that are known in data-free modeling studies.
We are particularly interested in the correlation between EWS and the time-varying repreoductive ratio, known as the effective reprodutive ratio $\left(\mathcal{R}_E\right)$.

## Research questions
1. Do model-independent early warning signals *track* or *anticipate* the effective reproductive ratio?
2. Do some early warning signals outperform others in terms of their ability to track or anticipate the effective reproductive ratio?
3. Does the degree to which early warning signals track or anticipate the effective reproductive ratio depend on the magnitude or dynamics of the effective reproductive ratio itself? For example, the temporal correlation between an EWS and $\mathcal{R}_E$ might be weak when $\mathcal{R}_E < 1$, where the dynamics are sub-critial and the observed time series is mainly driven by environmental or demographic stochasticity.

## Study design
### I. Fit a mechanistic SIR model to measles incidence data from 4 cities in Niger

The goal is fit a model to estimate:

 + The latent *S*, *I*, and *R* latent states
 + Time-varying rate of transmision, $\beta_t$
 + Time-varying effective reproductive ratio, $\mathcal{R}_{E(t)}$
    
The model is a continuous time SIR model, specified as a set of stochastic differential equations (SDEs):

\begin{align}
\frac{\text{d}S}{\text{d}t} &= b_t - \lambda_t S_t \\
\frac{\text{d}I}{\text{d}t} &= \lambda_t S_t - \gamma I_t \\
\frac{\text{d}R}{\text{d}t} &= \gamma I_t,
\end{align}

\noindent{}where $b_t$ is the number of births that occur in the interval $\text{d}t$, $\gamma$ is the time-invariant recovery rate, and $\lambda_t$ is the time-varying force of infection.
We model $\lambda_t$ as a function of a seasonal tranmission rate subject to additional environmental variability through time:

\begin{align}
\lambda_t &= \frac{\beta_t I_t + \psi}{N_t}, \\
\beta_t &= \beta \left(1 + \sum^6_{i=1} q_i \xi_{i_{t}} \right) \Gamma_t, 
\end{align}

\noindent{}where $\beta_t$ is the rate of transmission at time *t*, $\beta$ is the mean transmission rate, $\psi$ accounts for measles infections from external sources that are not part of the local dynamics, and the term $\sum^6_{i=1} q_i \xi_{i_{t}}$ is a B-spline to model seasonality in transmission.
The B-spline bases ($\xi_{i_{t}}$) are periodic with a 1 year period.
The transmission rate ($\beta_t$) is also subject to stochastic process noise at each time step, $\Gamma_t$, which we model as a gamma-distributed random variable with mean 1 and variance $\sigma^2$.
In this model, the effective reproductive ratio at time *t* is: $\mathcal{R}_{E(t)} = \beta_t / \gamma$.

We assume observed case reports ($\textbf{y}$) are drawn from a negative binomial distribution subject to a constant reporting fraction ($\rho$) and dispersion parameter $\tau$,

\begin{align}
y_t \sim \text{NegBin} \left( \rho I_t, \tau  \right).
\end{align}

We will fit the model to data via iterated filtering to maximize the likelihood, as implemented in the R package `pomp`.
We seek to estimate 14 parameters for each city (Table 1).

| Parameter | Description |
| --------- | ----------- |
| $\beta$ | Mean rate of transmission |
| $\gamma$ | Constant rate of recovery |
| $\rho$ | Constant reporting fraction |
| $q_i$ for $i \in \{1,2,3,4,5,6\}$ | B-spline coefficients for seasonality |
| $\psi$ | External infections |
| $\sigma^2$ | Variance of gamma-distributed process noise |
| $S_0$ | Initial conditions for susceptible class |
| $I_0$ | Initial conditions for infected class |
| $R_0$ | Initial conditions for recovered class |


Model fitting will proceed in three steps, independently for each city:
 
1. Generate initial parameter sets from a large Latin hypercube search space of 50000 parameter sets. Run 10 replicate particle filters at each of these parameter sets, with 2000 particles each. Retain the 5000 parameter sets with the highest likelihood.

2. Conduct a global parameter search using 10000 parameter sets from above. The parameter sets within the Latin hypercube will serve as starting conditions for iterated filtering using the function `pomp::mif2()`.

3. Conduct a local parameter search using the the 5000 parameter sets from the global search with the highest likelihoods. We will consider the parameter set with the highest likelihood at this stage to be the MLEs ($\hat{\theta}$).

4. To complete our inference from the model, we will perform particle MCMC using $\hat{\theta}$ as the initial conditions. The MCMC analysis allows us to estimate the uncertainty around all parameters and to generate estimates of the latent states and the $\mathcal{R}_E$ for the observed data. That is, we will end up with a time series of $\mathcal{R}_E$ that corresponds to the observation time series.
    - Can we get this from `pfilter(save.states)`?

### II. Calculate a suite of EWS (from the R package `spaero`) from the same data as used in I
This will be done with the function `spaero::get_stats`.

### III. Calculate the correlation between EWS and $\left(\mathcal{R}_E\right)$ and the significance of the correlation
This will be done with the functions `cor` and `cor.test`.

## Data sources
+ Niger measles data from project AERO
+ Permissions?

```{r data-example}
file_name <- "../niger_measles/niger_regional_1995_2005.csv"
niger_measles_raw <- read_csv(file_name, col_types = cols())

num_regions <- nrow(niger_measles_raw)
num_weeks <- ncol(niger_measles_raw) - 1  # subtract 1 from ncol() because first column are regions
weeks_per_year <- num_weeks/11
weeks <- rep(1:52, times = 11)

# Create a vector of years for all num_weeks
years <- rep(1995:2005, each = weeks_per_year)

# Function for calculating start of week based on week number and year
calculate_start_of_week = function(week, year) {
  date <- ymd(paste(year, 1, 1, sep="-"))
  week(date) = week
  return(date)
}

# Clean up the data frame
measles_data <- niger_measles_raw %>%
  gather(key = week, value = cases, -X1) %>%
  mutate(
    week_num = rep(1:num_weeks, each = num_regions),
    year = rep(years, each  = num_regions),
    week = rep(weeks, each = num_regions),
    date = calculate_start_of_week(week, year)
  ) %>%
  dplyr::rename(region = X1) %>%
  filter(grepl("City", region))

ggplot(measles_data, aes(x = date, y = cases, color = region)) +
  geom_path() +
  facet_wrap(~region, scales = "free_y") +
  scale_color_manual(values = ptol_pal()(4)) +
  ggtitle("Time series of data from 4 cities in Niger")
```


## Analysis
1. Plot time-indexed $\mathcal{R}_E$ and each EWS as scatterplots to visualize their correlations ($\rho$). This might look something like:

```{r plot-ex}
ncities <- 4
news <- 6
npoints <- 200
out <- tibble()
for(i in 1:ncities){
  for(j in 1:news){
    slope <- runif(1, 0.1, 2)
    sdd <- runif(1, 1, 4)
    x <- rnorm(200, 0, 1)
    y <- rnorm(200, x*slope, sdd)
    tmp <- tibble(
      city = i,
      ews = paste("EWS:",j),
      x = x,
      y = y
    )
    
    out <- bind_rows(out, tmp)
  }
}

ggplot(out, aes(x, y, fill = as.factor(city))) +
  geom_point(shape = 21) +
  facet_grid(as.factor(city)~as.factor(ews)) +
  scale_fill_manual(values = ptol_pal()(4)) +
  theme(legend.position = "top",
        axis.text=element_blank()) +
  labs(x = expression(R[E]), y = "EWS") +
  ggtitle("Random data showing example plot for the paper")

```

2. For each region, calculate temporal correlations between each EWS and $\mathcal{R}_E$, resulting in a table (or heatmap figure) like this:

| Region | EWS | $\boldsymbol{\rho}$ | *P*-value |
| ------ | --- | ------ | --------- |
| Agadez | Variance | 0.8 | 0.001 |
| Agadez | Mean | 0.4 | 0.09 |
| $\vdots$ | $\vdots$ | $\vdots$ | $\vdots$ |
| Zinder | Kurtosis | 0.7 | 0.006 |

## Checklist

+ ~~Create cleaned dataset of just the four focal cities from Niger~~
+ ~~Write R code to define the `pomp` model object (SDE)~~
+ Simulate time series from the `pomp` object with parameters that give us irregular dynamics like the observed data
+ Do test analysis of steps II-III using the simulated data
+ Perform iterated filter parameter search for MLEs
    - Get set up on UGA cluster
+ Calculate EWS on the observed data
    - Work with Eamon on bandwidth, etc.
+ Caclulate correlations with real data and empirically-derived $\mathcal{R}_E$
+ Write the paper!

