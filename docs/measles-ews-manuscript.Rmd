---
csl: science-without-titles.csl
fontsize: 11pt
geometry: margin=1in
header-includes:
 - \usepackage{amsmath,amssymb}
 - \usepackage{changepage}
 - \usepackage{textcomp,marvosym}
 - \usepackage{cite}
 - \usepackage{nameref,hyperref}
 - \usepackage[left]{lineno}
 - \usepackage{microtype}
 - \DisableLigatures[f]{encoding = *, family = * }
 - \usepackage[table]{xcolor}
 - \usepackage{array}
 - \usepackage[font={footnotesize, sf},labelfont=bf, labelsep=period]{caption}
 - \usepackage{lastpage,fancyhdr,graphicx}
 - \usepackage{epstopdf}
 - \usepackage{mathptmx} 
 - \usepackage{longtable,booktabs}
 - \usepackage[symbol]{footmisc}
 - \usepackage{setspace}\singlespacing
 - \usepackage[textsize=footnotesize,textwidth=2.1cm]{todonotes}
layout: 11pt
linkcolor: black
output:
  pdf_document:
    fig_caption: yes
    keep_tex: no
urlcolor: black
bibliography: /Users/atredenn/Dropbox/Bibliography/measles-ews.bib
---
<!-- Make a \smalltodo command for margins -->
\newcommand{\smalltodo}[2][]
    {\todo[caption={#2}, #1]
    {\begin{spacing}{0.5}#2\end{spacing}}}
\renewcommand\linenumberfont{\normalfont\tiny\sffamily\color{gray}}
\renewcommand{\figurename}{Fig.}
\renewcommand{\thefootnote}{\fnsymbol{footnote}}
\raggedright
\vspace*{0.2in}

\begin{centering}

{\LARGE
\textbf\newline{Critical slowing down anticipates\\emergence and elimination of measles in Niger} 
}

\vspace{2em}

Andrew T. Tredennick\textsuperscript{1,2}\footnote[1]{Corresponding author: atredenn@gmail.com}, \smalltodo{Eamon has been a huge help during this entire project, so I think deserves second author. Other potential authors include: Andrew Park, Toby Brett, and Matt Ferrari.}Eamon O'Dea\textsuperscript{1,2}, TBD\textsuperscript{1,2}, Pejman Rohani\textsuperscript{1,2}, \& John M. Drake\textsuperscript{1,2}

\textsuperscript{1} \small\emph{Odum School of Ecology, University of Georgia, Athens, GA, USA} \\
\textsuperscript{2} \small\emph{Center for the Ecology of Infectious Diseases, University of Georgia, Athens, GA, USA} \\

\end{centering}


<!-- Andrew W. Park\textsuperscript{1,2}, -->
<!-- Tobias Brett\textsuperscript{1,2}, -->
<!-- Matthew J. Ferrari\textsuperscript{3}, -->
<!-- \\ -->
<!-- \bigskip -->
<!-- \textsuperscript{3} \small\emph{Department of Biology, Pennsylvania State University, State College, PA, USA} -->


<!-- # Author Contributions -->
<!-- * Developed research questions: ATT, PR, JMD -->
<!-- * Provided data: MJF -->
<!-- * Designed the study: ATT, EO, AWP, PR, JMD -->
<!-- * Conducted the analyses: ATT, EO -->
<!-- * Analyzed and interpreted results: ATT, EO, AWP, TB, MJF PR, JMD -->
<!-- * Wrote the first draft: ATT -->
<!-- * Substantial revisions: ATT, EO, AWP, TB, MJF PR, JMD -->

# Abstract

\linenumbers

# Introduction

Forecasts of the emergence and re-emergence of infectious diseases have the potential to save lives, money, and human productivity by allowing for proactive, rather than reactive, preparedness measures [@Han2016].
Similarly, indicators of the elimination of infectious diseases can signal the effectiveness of ``end game'' strategies aimed at disease eradication [@Drake2017].
Predicting (re)emergence and elimination is possible with complex mathematical models of disease transmission, but their success relies on detailed understanding of the underlying transmission and pathogen dynamics.
We often do not have enough information to parameterize such models.
An alternative approach is to use model-independent statistical signals that portend infectious disease (re)emergence and elimination by detecting critical slowing down as the system approaches a critical transition [@ORegan2013].

Emergence and elimination of an infectious disease both involve a critical transition.
The transition typically occurs at the critical point where the basic reproduction number ($R_0$, the number of secondary cases that arise from a single infected case in a fully susceptible population) is equal to one [@Heffernan2005].
Thus, subcritical ($R_0 < 1$) and supercritical ($R_0 > 1$) systems represent alternative modes of fluctuation [@Scheffer2009; @Scheffer2012; @ORegan2013].

Critical transitions in stochastic systems, such as systems of disease transmission, are often associated with critical slowing down, a reduction in the resilience of a system to perturbations [@VanNes2007].
Critical slowing down (CSD), in turn, is associated with changes in the dynamical features of the system: early warning signals (EWS) such as an increase in the variance and autocorrelation [@Carpenter2006; @Scheffer2009].
Recent theoretical work suggests that CSD occurs as disease dynamics approach $R_0 = 1$ from below (emergence) [@ORegan2013; @Dibble2016] and from above (elimination) [@ORegan2013; @ORegan2016; @Drake2017], and that several EWS anticipate the critical transition [@Brett2017; @Brett2018; @Miller2017].
Empirical tests of EWS and associated CSD are, however, scarce.
Documenting CSD in real disease dynamics is an essential first step toward the development of model-independent outbreak detection systems [@Han2016].

Here, we use empirically-based model simulations of measles dynamics to test whether CSD anticipates critical transitions in real disease dynamics.
We focus on two scenarios: (1) the re-emergence of measles following a large outbreak, a situation typical of measles dynamics in sub-Saharan Africa, and (2) the elimination of measles by a vaccination campaign.
We seek to answer two related questions.
First, can CSD distinguish between time series of disease incidence when the underlying dynamics are far from and near to a critical transition?
If so, then CSD can anticipate disease re-emergence and elimination.
Second, how does the distance to and the rate of approaching the threshold impact the anticipatory skill of CSD?

To answer these questions, we fit mechanistic models of disease transmission to time series of measles incidence in four Nigerien cities.
We then use the fitted models to perform model experiments designed to test the performance of several EWS, which quantify CSD, at anticipating re-emergence and elimination.
Our results confirm theoretical expectations about several EWS and associated CSD.
In particular, we show that CSD before a critical transition is detectable by several EWS in realistic scenarios, and they do so using much shorter time series than used in theoretical studies.
However, our study highlights the limitations of EWS in situations where disease re-emergence and elimination occurs rapidly.
Moreoever, and contrary to theoretical expectations [@ORegan2013], we find that EWS perform better at detecting CSD before re-emergence than before elimination.

# Materials and Methods

## Data
We used weekly measles case report data from four Nigerien cities: Agadez, Maradi, Niamey, and Zinder (Fig. \ref{fig:data}A).
The data were collected over an 11 year period from 1995-2005 (Fig. \ref{fig:data}B).
These data are ideal for testing theory on CSD in disease dynamics because each city has different population sizes, has different dynamics in terms of outbreak sizes and length of inter-epidemic periods, and each time series has different amounts of demographic stochasticity due to differences in population size.
Such differences provide a natural gradient of "noise" that may influence CSD [@ORegan2018].
The data come from [*somewhere/someone*], and used here with permission from [*somewhere/someone*].

\smalltodo{These prediction intervals still include the random walk transmission rate during filtering. Should we remove that dynamic now that our focus is not on changing tranmission rate over time?}
\begin{figure}[!ht]
\centering
\includegraphics[width=\textwidth]{../figures/map-and-series.pdf}
\caption{\textbf{Locations of data sources and observed and predicted measles dynamics}. (\textbf{A}) Locations and population sizes (in parantheses) of our four focal cities in Niger. (\textbf{B}) Time series of weekly reported cases (yellow solid lines) and the 95\% prediction intervals (black ribbons) for one-step-ahead predictions from our fitted SEIR models for each city.}
\label{fig:data}
\end{figure}

## Stochastic *SEIR* model
The model is a discrete-time approximation of a continuous-time SEIR model with limited demography, specified as a set of difference equations,

\begin{align}
S_{t+dt} &= n_{S,t} - n_{E,t} \\
E_{t+dt} &= n_{E,t} - n_{I,t} \\
I_{t+dt} &= n_{I,t} + n_{O,t} - n_{R,t},
\end{align}

\noindent{}where $\textbf{n}_t$ are random variables representing the number of individuals transitioning into or out of each class at each timestep $t \rightarrow t+dt$.
$n_{S}$ is the number of births, $n_{E}$ is the number of newly infected individuals that have the disease but are not infectious, $n_{I}$ is the number of newly infectious indiviuals, $n_{O}$ is the number of imported infections, and $n_{R}$ is the number of newly recovered individuals who are no longer infectious and have life-long immunity.
The stochastic random variables are specified as follows:

\begin{align}
n_{S,t} &\sim \text{Poisson}(\mu_t N_t \times dt) \\
n_{E,t} &\sim \text{Binomial}(\lambda_{E,t}, S_{t}) \\
n_{I,t} &\sim \text{Binomial}(\lambda_{I,t}, E_{t}) \\
n_{O,t} &\sim \text{Poisson}(\psi \times dt) \\
n_{R,t} &\sim \text{Binomial}(\lambda_{R,t}, I_{t}),
\end{align}

\noindent{}where $\mu_t$ is the birth rate at time *t*, $\psi$ is the rate of imported infections, and $\lambda_E$, $\lambda_I$, and $\lambda_R$ are the probabilities of exposure, becoming infectious, and recovery, respectively.
These probabilities reflect the processes of tranmission, transition from the latent period to the infectious period, and recovery, which we model as:

\begin{align}
\lambda_{E,t} &= 1 - e^{-\frac{\beta_t I_t dt}{N_t}} \\
\lambda_{I,t} &= 1 - e^{-\eta E_{t} dt} \\
\lambda_{R,t} &= 1 - e^{-\gamma I_{t} dt},
\end{align}

\noindent{}where $\beta_t$ is time-varying rate of transmission, $\eta$ is time-invariant rate from the exposed class to the infectious class, and $\gamma$ is time-invariant recovery rate.
We model rate of transmission as:

\begin{equation}
\beta_t = \beta \left(1 + \sum^6_{i=1} q_i \xi_{i_{t}} \right) \Gamma_t.
\end{equation}

$\beta$ is the mean transmission rate, $\psi$ accounts for measles infections from external sources that are not part of the local dynamics, and the term $\sum^6_{i=1} q_i \xi_{i_{t}}$ is a B-spline to model seasonality in transmission.
The B-spline bases ($\xi_{i_{t}}$) are periodic with a 1 year period.
The transmission rate ($\beta_t$) is also subject to stochastic process noise at each time step, $\Gamma_t$, which we model as gamma-distributed white (temporally uncorrelated) noise with mean 1 and variance $\sigma^2$ [@Breto2011].

We do not include a death process in the model because the rate of infection is much faster than the rate of death.
Excluding deaths means we can avoid making further assumptions about demographic rates -- we are already making assumptions about birth rates (e.g., the rate is the same across cities, but with city-specific population size).
We model demographic stochasticity in births and imported infections by drawing time-specific values from Poisson distributions.
Transitions in the model are shown in Table 1.
In this model, the effective reproduction number at time *t* is: $R_E(t) = \frac{\beta_t}{\gamma} \frac{S_t}{N_t}$.

We assume observed case reports ($\textbf{y}$) are drawn from a Negative Binomial distribution subject to a constant reporting fraction ($\rho$) and dispersion parameter $\tau$,

\begin{align}
y_t \sim \text{Negative Binomial} \left( \rho I_t, \tau \right).
\end{align}

<!-- | Transition | ($\Delta S$, $\Delta E$, $\Delta I$) | Propensity | -->
<!-- | --------------- | ------------ | -------------------------------------------- | -->
<!-- | birth | $(1, 0, 0)$ | $N_t \mu_t$ | -->
<!-- | transmission (deterministic) | $(-1, 1, 0)$ | $SI \beta_t / N_t$ | -->
<!-- | transmission (stochastic) | $(-k, k, 0)$ | $\frac{S}{k}\sum^k_{j=0} \left(\begin{matrix}k\\j\end{matrix} \right) (-1)^{k-j+1} \tau_{\text{f}}^{-1} \text{ln}(1 + (\beta_tI/N_t)) \tau_{\text{f}} (S-j)$ | -->
<!-- | symptomatic (infectious) | $(0,-1,1)$ | $E\eta$ -->
<!-- | imported infections | $(0, 0, 1)$ | $\psi_t$ | -->
<!-- | recovery | $(0, 0, -1)$ | $I\gamma$ | -->

<!-- Table: Transitions in the SEIR model. We show the determinstic transmission rate for clarity, but our model uses the stochastic tranmission rate. -->

##  Model fitting and inference

We fit the SEIR model to time series of case reports from each of our focal cities using Maximization by Iterated particle Filtering (MIF).
We estimated 14 parameters for each city: six seasonal transmission parameters ($q_i$), mean transmission rate ($\beta$), three initial conditions $\left(S_{(t=0)},E_{(t=0)},I_{(t=0)}\right)$, the number of imported infections ($\psi$), reporting fraction ($\rho$), one parameter accounting for process noise ($\sigma$), and one parameter accounting for measurement noise ($\tau$).
To ensure identifiability, and to make the model easier to fit, we assumed the infectious period was fixed at $1/\eta = 8$ days and the recovery period was fixed at $1/\gamma = 5$ days.
The birth rate ($\mu_t$) was multiplied by 0.3 to account for the reported 70\% vaccination coverage [@Ferrari2008].

MIF relies on particle filtering, which estimates the likelihood of fixed parameters by integrating state variables of a stochastic system.
To narrow in on the maximum likelihood estimates, MIF lets parameters take a random walk during the filtering process and selectively propagates forward parameter sets (i.e., particles) with the highest likelihood.
The variance of the random walk decreases at each iteration of MIF, where a MIF iteration means one filtering pass through the time series.
This procedure converges toward the maximimum likelihood estimates (MLEs), in theory.

We used the IF2 algorithm [@Ionides2015] implemented in the R [@R2017] package `pomp` [@King2016; @King2018] to conduct the MIF procedure.
To initialize MIF, we generated 5000 parameter sets using Latin Hypercube Sampling over large ranges of the parameter values.
We then performed two rounds of MIF, each for 100 iterations, with 10000 particles, and geometric cooling.
For the first round of MIF we set `cooling.facter = 1`.
For the second round, which was initialized using the collection of parameter sets from the end of the first round, we set `cooling.factor = 0.9`.
We computed the log likelihood of 5000 final MIF parameter sets (i.e., parameter sets collected after 200 MIF iterations) as the log of the mean likelihoods of 50 replicate particle filters with 10000 particles each.
At this stage, we assume the parameter set with highest log likelihood is the MLE.

We used a bootstrapping approach to estimate approximate 95\% confidence intervals for all parameters.
The procedure, which was conducted for each city independently, is as follows.
First, we simulated 100 realizations from the fitted model using the MLE parameters.
Second, we fitted the SEIR model to each of the 100 bootstrap simulations using the same MIF procedure described above, except we initiated the parameter search from 50 parameter sets rather then 5000.
We reduced the number of parameter sets due to the computational constraints of fitting 100 simulated data sets for each of the four cities.
Third, we identified the MLE parameter set for each of the 100 bootstrap simulations from among the 50 MIF paramete sets.
Last, we calculated summary statistics (mean, median, quantiles) from the distribution of 100 MLE parameters (SI text).

<!-- We used profiling to estimate 95\% confidence intervals for four parameters of interest: mean transmission rate ($\beta$), the initial fraction of susceptible individuals $\left(S_{(t=0)}\right)$, the number of imported infections ($\psi$), and reporting fraction ($\rho$). -->
<!-- For each parameter, we profiled over a range of 100 values using the same MIF and likelihood estimate procedure as described above for finding the MLEs. -->
<!-- We replicated the profiling procedure 10 times for each unique value of the focal parameter and then took the log of the mean of those 10 profiled likelihoods. -->
<!-- These values were used to estimate 95\% confidence intervals using the Monte Carlo-adjusted profile algorithm described by @Ionides2017. -->

## Model simulations

### Model-data comparisons
We used the MLE parameter sets to make one-step-ahead predictions and to test the ability of early warning signals to anticipate the critical transition at $R_E(t) = 1$.
To make one-step-ahead predictions, we used particle filtering with 50000 particles and retained the mean and standard deviation of all latent states across all particles before they were filtered at each time step.
We used the mean predictions ($\mathbb{E}(\text{cases}_t)$) to assess model fit using a generalized coefficient of determination, calculated as: $R^2 = 1 - \frac{\sum_t [\mathbb{E}(\text{cases}_t) - \text{cases}_t]^2}{\sum_t [\text{mean(cases)}-\text{cases}_t]^2}$ [@Martinez-Bakker2015].
<!-- To estimate a trend in tranmission rate, we allowed mean transmission to take a random walk throughout the filter and retained the filtered distribution of particles for mean transmission and $R_E(t$). -->

### Simulating re-emergence
To simulate re-emergence of measles, we manipulated the initial size of the susceptible pool to simulate an increase from low $R_E(t)$ to high $R_E(t)$.
Doing so allows us to test whether EWS can distinguish between windows of time when $R_E(t)$ is far from a critical transition and when $R_E(t)$ is near a critical transition.
We reduced the initial fraction of susceptible individuals by multplying the MLE for $S_{(t=0)}$ by six discounting factors: 1e-4, 0.1, 0.2, 0.3, 0.4, and 0.5.
These discounting factors represent situations of susceptible depletion after outbreaks of various size.
We then simulated the model forward for thirty years using mean birth and death rates for the entire country.
Thirty years was long enough for yearly average $R_E(t)$ to reach 1 for each city.
Because the model is stochastic, we repeated these simulations 500 times for each city-susceptible discount combination.

Next, we split each simulated time series into null and test intervals.
First, across all simulations for a city-susceptible discount combination, we found the simulation year in which $R_E(t)$ reaches or exceeds 1, and excluded years past that year (SI text).
We split the remaining time series into two windows of equal length (Fig. S2).
The null interval is the first window, where $R_E(t)$ is increasing but far from 1.
The test interval is the second window, where $R_E(t)$ is increasing and approaching 1.
We did this for each city and for each level of susceptible depletion.
We calculated EWS over null and test intervals separately.

### Simulating elimination
To simulate elimination, we simulated a vaccine campaign in which vaccination coverage linearly increased over time to eventually reach 100\%, i.e. eradication (Fig. S3).
We ran simulations for 100 years, starting with 50 years of dynamics at the baseline vaccine coverage reported for Niger of 70\%, $p = 0.7$ [@Ferrari2008].
Note that vaccination coverage is included in our model by discounting the birth rate of susceptibles by $1-p$.
At year 50, we initiated the vaccination campaign and let the model run for another 50 years.
We ran simulations across six vaccination ``speeds'' (the rate at which $p \rightarrow 1$; SI text), simulating situations of slow and fast approaches to elimination.

We then split each time series into null and test intervals for calculating EWS.
We define the test interval as the window of time between the start of the vaccination campaign (year 50) and the time at which vaccination coverage reached the vaccination threshold of $1 - 1/R_0$.
$R_0$ was calculated for each city using the MLE parameters (SI text).
We define the null interval as the window of time that ends at the start of the vaccination campaign (year 49) and starts at a time that results in an interval equal in length the test interval (Fig. S3).
EWS were then calculated for each interval.

## Early warning signals

We considered nine candidate early warning signals (SI Table S.x).
We used the `spaero::get_stats()` function [@ODea2018] in R [@R2017] to calculate EWS according to the formulas in Table 2.
All EWS except the coefficient of variation are expected to increase as $R_E(t)$ approaches 1 from below [@ORegan2013; @ORegan2016; @Brett2018].
Less is known about the behavior of EWS as $R_E(t)$ approaches 1 from above.
But, theory does tell us that, for SIR models, the mean should decrease, autocorrelation should increase, and the variance should decrease [@ORegan2013].

For each simulation of re-emergence and elimination, we calculated EWS for the time series of expected cases in the null and test intervals.
This yielded a distribution of EWS over the 500 null and test intervals.
We assessed the performance of each EWS using the Area Under the Curve (AUC) statistic.
Specifically, we use AUC to calculate the amount of overlap between the distributions of each EWS from the null and test intervals.
Higher values of AUC indicate a greater degree of separation and thus better performance of a particular EWS in terms of classifying whether $R_E(t)$ is close to a critical transition.
We used the `pROC:auc()` function [@Robin2011] in R to calculate AUC values.


<!-- | EWS | Estimator | Theoretical Correlation with $R_E(t)$ | -->
<!-- | -------------------- | ----------------------------------- | ------------------------ | -->
<!-- | Mean | $\mu_t = \sum^{t+(b-1)\delta}_{s=t-(b-1)\delta} \frac{X_s}{2b-1}$ | Positive | -->
<!-- | Variance | $\sigma_t^2 = \sum^{t+(b-1)\delta}_{s=t-(b-1)\delta} \frac{\left(X_s - \mu_s\right)^2}{2b-1}$ | Positive | -->
<!-- | Coefficient of variation | $CV_t = \frac{\sigma_t}{\mu_t}$ | Null | -->
<!-- | Index of dispersion | $ID_t = \frac{\sigma_t^2}{\mu_t}$ | Positive | -->
<!-- | Skewness | $S_t = \frac{1}{\sigma^3_t} \sum^{t+(b-1)\delta}_{s=t-(b-1)\delta} \frac{\left(X_s - \mu_s\right)^3}{2b-1}$ | Positive | -->
<!-- | Kurtosis | $K_t = \frac{1}{\sigma^4_t} \sum^{t+(b-1)\delta}_{s=t-(b-1)\delta} \frac{\left(X_s - \mu_s\right)^4}{2b-1}$ | Positive | -->
<!-- | Autocovariance | $\text{ACov}_t = \sum^{t+(b-1)\delta}_{s=t-(b-1)\delta} \frac{\left(X_s - \mu_s\right)\left(X_{s-\delta} - \mu_{s-\delta}\right)}{2b-1}$ | Positive | -->
<!-- | Autocorrelation | $\text{AC}_t = \frac{\text{ACov}_t}{\sigma_t \sigma_{t-\delta}}$ | Positive | -->
<!-- | Decay time | $\overline{\tau}_t = -\delta / \text{ln}\left[\text{AC}_t(\delta)\right]$ | Positive | -->

<!-- Table: List of candidate early warning signals and their estimating equations. Note that *b* denotes the bandwidth. See @Brett2018 for details. -->

<!-- | First differenced variance | $\Delta\sigma_t^2 = \sigma_t^2 - \sigma_{t-\delta}^2$ | Positive | -->



# Results
\todo[inline]{$R_0$ in Figure 2 is calculated with $\mu = \nu$ = 0.05 because those are the values I use when simulating the model (death rate equals birth rate to maintain constant mean population size over simulations). However, we could use the real death rate for Niger in Figure 2 such that $\mu \ne \nu$, in which case the $R_0$ would better reflect the data (rather than the simulations).}

The fitted models adequately reproduce observed dynamics (Fig. 1B), with in-sample $R^2$s from one-step-ahead predictions ranging from 0.54 for Agadez to 0.89 for Maradi (Fig. \ref{fig:scatters}A).
Stochastic simulations of the models displayed dynamics typical of each city (Fig. S1), including the decline in seasonality amplitude as population size decreases (Fig. \ref{fig:scatters}B) [@Ferrari2008].
Our model for Agadez performs poorly relative to the other cities.

\begin{figure}[!ht]
\centering
\includegraphics[width=\textwidth]{../figures/pred-obs-scatters.pdf}
\caption{\textbf{Accuracy of the fitted \emph{SEIR} models and estimated seasonality.} (\textbf{A}) Comparison of in-sample model predictions and observations for each city. Expected cases are one-step-ahead predictions from the fitted models. The dashed line shows 1:1. Coefficients of determination ($R^2$) were calculated as the reduction in the sum-of-squared errors from model predictions relative to a null model of the mean number of cases (SI text). (\textbf{B}) The estimated seasonality of the basic reproductive ratio ($R_0$) for each city. $R_0$ was calculated as: $\frac{\eta \beta_t \mu}{\nu(\eta+\nu)(\gamma+\nu)}$, where $1/\eta$ is the infectious period, $1/\gamma$ is the recovery period, $\beta_t$ is the time-specific rate of transmission, $\mu$ is the birth rate, and $\nu$ is the death rate. Only $\beta_t$ is estimated by our model. We set $1/\eta$ = 8 days, $1/\gamma$ = 5 days, $\mu = \nu$ = 0.05 for calculating $R_0$ as shown in this figure. The white line is $R_0$ calculated using the MLE parameters; shaded regions are the bootstrap 95\% confidence intervals.}
\label{fig:scatters}
\end{figure}

<!-- We found no evidence of a directional trend in the rate of tranmission over the course of the time series (Figure Sx). -->
<!-- Seasonal fluctuations in all cities cause $R_E(t)$ to go above and below 1 throughout the course of a year (Figure Sx). -->
<!-- This results in the observed outbreak cycles in low population cities and the more unpredictable outbreaks in larger cities (Figure 1). -->

<!-- Stochastic simulations from sub-critical ($R_E(t) \ll 1$) to critical dynamics ($R_E(t) = 1$) differed among the four cities (Figure \ref{fig:re-sims}). -->
<!-- The differences in the rate at which $R_E(t)$ approaches one is a combination of population size, mean transmission rate, and seasonality (Table 3). -->
<!-- For example, the dynamics of Niamey reach $R_E(t) = 1$ much faster than the other cities that have smaller populations, lower transmission rates (generally), and lower seasonal amplitude. -->

```{r mles, warning=FALSE, message=FALSE, results='asis', echo=FALSE}
library(tidyverse)
library(dplyr)
library(xtable)

options(xtable.comment = FALSE)

result_files <- list.files("../results/")
mle_files <- result_files[grep("initial-mif-lls", result_files)]
boot_files <- result_files[grep("bootstrap-mif-lls", result_files)]

mles <- tibble()
for(do_file in mle_files){
  tmp <- read.csv(paste0("../results/", do_file)) %>%
    drop_na() %>%
    filter(loglik == max(loglik)) %>%
    dplyr::select(loglik, loglik_se, beta_mu, beta_sd, iota, rho, S_0) %>%
    gather(key = parameter, value = mle) %>%
    mutate(city = str_sub(do_file, 17, (nchar(do_file)-4)))
  
  mles <- bind_rows(mles, tmp)
}

nboots <- 100
nmifs <- 50
comp_grid <- expand.grid(1:nboots, 1:50)
colnames(comp_grid) <- c("boot_series", "param_set")
comp_grid$do_grid <- 1:nrow(comp_grid)
boots <- tibble()
for(do_file in boot_files){
  do_city <- str_sub(do_file, 19, -5)
  tmp_file <- read.csv(paste0("../results/", do_file)) %>%
    slice(2:n()) %>%  # ignore first row of NAs
    left_join(comp_grid, by = "do_grid") %>%  # merge in comp grid info
    group_by(boot_series) %>%
    filter(loglik == max(loglik)) %>%
    ungroup() %>%
    dplyr::select(-do_grid, -loglik, -loglik_se, -boot_series, -param_set,
                  -b1, -b2, -b3, -b4, -b5, -b6) %>%
    gather(key = parameter, value = mle_value) %>%
    group_by(parameter) %>%
    summarise(
      mean_value = mean(mle_value),
      median_value = median(mle_value),
      std_dev = sd(mle_value),
      upper_95_ci = quantile(mle_value, 0.975),
      lower_95_ci = quantile(mle_value, 0.025)
    ) %>%
    mutate(city = do_city)
  
  boots <- bind_rows(boots, tmp_file)
}

boot_cis <- boots %>%
  dplyr::select(city, parameter, lower_95_ci, upper_95_ci)

mles_cis <- mles %>%
  left_join(boot_cis) %>%
  drop_na() %>%
  mutate(
    table_value = paste0(round(mle,2), " (", round(lower_95_ci,2), ", ", round(upper_95_ci,2), ")")
  ) %>%
  dplyr::select(city, parameter, table_value)

loglik_bindr <- mles %>%
  spread(key = parameter, value = mle) %>%
  arrange(city) %>%
  mutate(
    loglik_and_se = paste0(round(loglik,2), " (", round(loglik_se,2), ")")
  ) %>%
  dplyr::select(city, loglik_and_se) %>%
  gather(parameter, table_value, -city)

mles_table <- bind_rows(loglik_bindr, mles_cis) %>%
  spread(parameter, table_value) %>%
  arrange(city) %>%
  dplyr::select(city, loglik_and_se, beta_mu, iota, rho, S_0) %>%
  dplyr::rename(
    City = city,
    `Log likelihood (S.E.)` = loglik_and_se,
    `$\\beta$ (95\\% C.I.)` = beta_mu,
    `$\\psi$ (95\\% C.I.)` = iota,
    `$\\rho$ (95\\% C.I.)` = rho,
    `$\\textsl{S}_{t=0}$ (95\\% C.I.)` = S_0
  )


# mles_table <- mles %>%
#   spread(key = key, value = value) %>%
#   arrange(city) %>%
#   mutate(
#     loglik_and_se = paste0(round(loglik,2), " (", round(loglik_se,2), ")")
#   ) %>%
#   dplyr::select(city, loglik_and_se, beta_mu, beta_sd, iota, rho, S_0) %>%
#   dplyr::rename(
#     City = city,
#     `Log likelihood (S.E.)` = loglik_and_se,
#     `$\\beta$ (95% C.I.)` = beta_mu,
#     `$\\sigma$ (95% C.I.)` = beta_sd,
#     `$\\psi$ (95% C.I.)` = iota,
#     `$\\rho$ (95% C.I.)` = rho,
#     `$\\textsl{S}_{t=0}$ (95% C.I.)` = S_0
#   )

print(xtable::xtable(mles_table, digits = 2, caption = "Maximum likelihood estimates and 95\\% bootstrapped confidence intervals for select epidemiological parameters. MLEs and C.I.s for all parameters are in the SI material."), caption.placement = "top", include.rownames = F, sanitize.colnames.function = identity, size="\\fontsize{9pt}{10pt}\\selectfont", table.placement="b")

```

In the approach to re-emergence, the EWS generally perform as expected, with Niamey being an exception (Fig. \ref{fig:aucs}A).
Skewness, kurtosis, and coefficient of variation performed poorly across all levels of susceptible depletion in all cities except Niamey.
For Niamey, it appears these metrics perform well at the highest levels of susceptible depletion (i.e., low discounting factors).
In fact, the high AUC values for Niamey result from exceptionally poor performance: they are all higher in the null interval rather than the test interval, contrary to theoretical expectations (Table 2).
Thus, these metrics are unreliable.

For the other cities, variance, mean, index of dispersion, decay time, autocovariance, and autocorrelation all perform equally well at predicting re-emergence (Fig. \ref{fig:aucs}A).
Their performance declines as the amount of susceptible depletion decreases.
This is expected because more rapid returns to $R_E(t)=1$ result in shorter null and test intervals, making estimates of EWS less precise.
Likewise, as the total time to reach $R_E(t)=1$ decreases, the null and test intervals start to behave more similarly.
In part, this is because susceptible replenishment is linear in our model.
Nonlinear increases in the susceptible pool would lead to different dynamics.

The EWS did not perform as well when anticipating elimination, relative to emergence (Fig. \ref{fig:aucs}B).
Only three metrics are reliable: mean, autocovariance, and variance.
All three metrics decreased as $R_E(t)$ approached the critical transition (Fig. S5).
As in the case of anticipating elimination, AUC values decreased as the speed of the vaccine campaign increased.
Again, this is due to shorter null and test intervals.

In all, the suite of EWS suggest that critical slowing down does occur in measles dynamics as a critical transition is approached.
We found similar results when calculating EWS over a moving window in the null and test intervals (SI text, Fig. Sx).

<!-- \begin{figure}[!ht] -->
<!-- \centering -->
<!-- \includegraphics[width=\textwidth]{../figures/re-simulated-series-grid.pdf} -->
<!-- \caption{Yearly average $R_E(t)$ (blue lines) across 500 model simulations at the MLE parameters and 20 representations simulations (grey lines) for each city. Each row of panels is for one level of susceptible depletion, indicated by the value on the right-most edge of the plots. The horizontal dashed line shows where $R_E(t) = 1$. The vertical solid red lines show the time point at which yearly average $R_E(t) \ge 1$. The time periods before the red line for each city were used for testing early warning signals.} -->
<!-- \label{fig:re-sims} -->
<!-- \end{figure} -->

\begin{figure}[!ht]
\centering
\includegraphics[width=\textwidth]{../figures/simulation-grid-aucs.pdf}
\caption{\textbf{Performance of early warning signals (EWS) over fixed windows}. EWS were calculated over two windows, one far from a critical transition and one near, for simulations of re-emergence (\textbf{A}) and elimination (\textbf{B}). EWS performance is quantified using the AUC metric, which we show here as a heatmap of AUC values minus 0.5. AUC values closer to 0.5 indicate higher ability to distinguish among time series near and far from a critical transition. The asterisks (*) in (A) for Niamey note EWS with high AUC but for the wrong reason: skewness and kurtosis \emph{decrease} as $R_E(t)$ approaches 1 rather than increase. This occurs because of the negative binomial sampling in the measurement component of our SEIR model.}
\label{fig:aucs}
\end{figure}

<!-- \begin{figure}[!ht] -->
<!-- \centering -->
<!-- \includegraphics[width=\textwidth]{../figures/simulation-mvw-grid-aucs.pdf} -->
<!-- \caption{\textbf{Performance of early warning signals (EWS) over moving windows}. EWS were calculated over moving windows of 35 weeks for two sets, one far from a critical transition and one near, for simulations of re-emergence (\textbf{A}) and elimination (\textbf{B}). EWS performance is quantified using the AUC metric, which we show here as a heatmap of AUC values minus 0.5. AUC values closer to 0.5 indicate higher ability to distinguish among time series near and far from a critical transition.} -->
<!-- \label{fig:aucs2} -->
<!-- \end{figure} -->

# Discussion

Using empirically-based disease transmission models, we found evidence of critical slowing down before critical transitions to re-emergence and elimination of measles.
This evidence comes from the fact that several EWS accurately anticipate the critical transition.

```{r susc-deplete, warning=FALSE, message=FALSE, echo=FALSE}
library(tidyverse)
library(dplyr)
library(pomp)
library(ggthemes)

# Define threshold for outbreak year --------------------------------------

# Outbreaks defined as: an annual case count exceeding x% of the maximum
# annual case count for a region, where x is the threshold set below.
outbreak_threshold <- 0.8  # 80% of max = outbreak year


# Load simulated data -----------------------------------------------------

cities <- c("Agadez", "Maradi", "Niamey", "Zinder")
sim_data <- tibble()
for(do_city in cities){
  tmp_file <- paste0("../simulations/bootstrap-sims-", do_city, ".RDS")
  tmp_data <- readRDS(tmp_file) %>%
    unnest() %>%
    mutate(city = do_city)
  sim_data <- bind_rows(sim_data, tmp_data)
}


# Identify outbreak years and calculate S depletion -----------------------

outbreak_years <- sim_data %>%
  mutate(year = trunc(time)) %>%
  group_by(city, sim, year) %>%
  summarise(total_cases = sum(reports),
            max_S = max(S),
            min_S = min(S)) %>%
  mutate(outbreak = ifelse(total_cases > outbreak_threshold*max(total_cases), 
                           TRUE, FALSE),
         max_S_t_minus_1 = lag(max_S),
         susc_depletion = min_S / max_S_t_minus_1) %>%
  filter(outbreak == TRUE) %>%
  drop_na()


# Calculate fraction of depletions less than 0.5 --------------------------

fracs_less_than_half <- outbreak_years %>%
  ungroup() %>%
  group_by(city) %>%
  mutate(
    deplete_half = ifelse(susc_depletion < 0.5, TRUE, FALSE)
  ) %>%
  group_by(city, deplete_half) %>%
  count() %>%
  group_by(city) %>%
  mutate(
    frac_less = n/sum(n)
  ) %>%
  filter(deplete_half == TRUE) %>%
  dplyr::select(city, frac_less)

percs <- fracs_less_than_half$frac_less*100
```

A potential limitation of our findings is that the levels of susceptible depletion we modeled (Fig. \ref{fig:aucs}A) might be lower than the levels that occur in reality.
To check the relevance of this limitation, we calculated the level of susceptible depletion after outbreaks (defined as years where the total number of cases reached 80% of the maximum observed) across one hundred replicate simulations (SI text).
We found that susceptible depletion was less than 0.5, the smallest susceptible depletion level we tested, for `r round(percs[1], 1)`% of outbreaks in Agadez, `r round(percs[2])`% of outbreaks in Maradi, `r round(percs[3])`% of outbreaks in Niamey, and `r round(percs[4])`% of outbreaks in Zinder.
These statistics do not detract from our main findings of CSD in measles dynamics, but they do suggest that EWS might be less useful in some cases than in others.
For example, AUC values for emergence at the 0.5 level of susceptible depletion are already low for most cities (Fig. \ref{fig:aucs}A).
Thus, EWS are not practical for cities that rarely experience levels of susceptible depletion below 0.5 (e.g., Agadez).

\nolinenumbers

# Acknowledgments
This research was funded by the National Institute of General Medical Sciences of the National Institutes of Health (Award Number U01GM110744).
The funders had no role in study design, data collection and analysis, decision to publish, or preparation of the manuscript.
This work was done on the Olympus High Performance Compute Cluster located at the Pittsburgh Supercomputing Center at Carnegie Mellon University, which is supported by National Institute of General Medical Sciences Modeling Infectious Disease Agent Study (MIDAS) Informatics Services Group grant 1U24GM110707.

# References
