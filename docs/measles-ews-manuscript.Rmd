---
csl: ecology.csl
fontsize: 11pt
geometry: margin=1in
header-includes:
 - \usepackage{amsmath,amssymb}
 - \usepackage{changepage}
 - \usepackage{textcomp,marvosym}
 - \usepackage{cite}
 - \usepackage{nameref,hyperref}
 - \usepackage[left]{lineno}
 - \usepackage{microtype}
 - \DisableLigatures[f]{encoding = *, family = * }
 - \usepackage[table]{xcolor}
 - \usepackage{array}
 - \usepackage[font=small,labelfont=bf]{caption}
 - \usepackage{lastpage,fancyhdr,graphicx}
 - \usepackage{epstopdf}
 - \usepackage{mathptmx} 
 - \usepackage{longtable,booktabs}
 - \usepackage[symbol]{footmisc}
layout: 11pt
linkcolor: black
output:
  pdf_document:
    fig_caption: yes
    keep_tex: no
urlcolor: black
bibliography: /Users/atredenn/Dropbox/Bibliography/measles-ews.bib
---
\renewcommand{\thefootnote}{\fnsymbol{footnote}}
\raggedright
\vspace*{0.2in}

\begin{centering}

{\LARGE
\textbf\newline{Early warning signals anticipate critical transitions\\in empirically-based simulations of measles dynamics in Niger} 
}

\vspace{2em}

Andrew T. Tredennick\textsuperscript{1,2}\footnote[1]{Corresponding author: atredenn@gmail.com},
Eamon O'Dea\textsuperscript{1,2},
Tobias Brett\textsuperscript{1,2},
Pejman Rohani\textsuperscript{1,2},
\& John M. Drake\textsuperscript{1,2}
\\
\bigskip
\textsuperscript{1} \small\emph{Odum School of Ecology, University of Georgia, Athens, GA, USA} \\
\textsuperscript{2} \small\emph{Center for the Ecology of Infectious Diseases, University of Georgia, Athens, GA, USA}

\end{centering}



# Abstract
Forecasting the trajectory of infectious disease outbreaks over time is a fundamental challenge facing society.

\linenumbers

# Introduction

Theory shows that epidemic transitions can be anticipated by trends in the statistical properties of disease time series (AERO papers).
The existence of statistical trends in the data that precede critical transitions, so-called 'early warning signals' (EWS), imply that we may be able to anticipate disease emergence and outbreaks.
The end goal is a model-independent detection system, where statistical properties of disease surveilence data can trigger warnings of impending outbreaks without the need to fit mechanistic models of disease transmission [@Han2016].

However, there is currently a gap between the theoretical work, which has relied on knowing the underlying disease dynamics, and the eventual goal of applying EWS in real-world situations where the underlying disease dynamics may be unknown.
Theoretical development of EWS has focused on anticipating when the population becomes supercritical, when $R_0 > 1$, after which an outbreak is inevitable, perhaps with some bifurcation delay [@Dibble2016].
Knowing the value of $R_0$ through time makes it possible to test the accuracy of EWS that are estimated from state variables alone.
Empirical application of EWS does not require knowing the value of $R_0$ through time, meaning that "tests" require making assumptions about when critical transitions occur.
Whether EWS track and/or anticipate underlying dynamics of real disease time series remains unknown, and is a critical knowledge gap that must be filled before EWS can confidently be deployed.

To fill this gap we will fit a mechanistic model to incidence data of measles in Niger to estimate the temporal epidemiology of the disease, yielding the very same parameters that are known in data-free modeling studies.
In particular, we are interested in the correlation between EWS and the time-varying repreoductive ratio, known as the effective reprodutive ratio $\left(R_E\right)$.
If EWS and $R_E$ are significantly and positively correlated, then we have empirical evidence that EWS are applicable in real-world settings.
If EWS and $R_E$ are negatively correlated or not significantly posivitely correlated, then we have evidence that EWS may not be applicable in certain settings.

# Materials and Methods

## Data
We used weekly measles case report data from four Nigerien cities, collected over an 11 year period (1995-2005) (Figure \ref{fig:data}).
These data are ideal for stress testing EWS because each city has different population sizes, has different dynamics in terms of size of outbreaks and length of inter-epidemic periods, and each time series has different amounts of demographic stochasticity due to differences in population size.
The data come from [*somewhere/someone*], and used here with permission from [*somewhere/someone*].

\begin{figure}[!ht]
\centering
\includegraphics[width=\textwidth]{../figures/map-and-series.pdf}
\caption{(A) Locations and population sizes (in parantheses) of our four focal cities in Niger. (B) Time series of reported cases (yellow solid lines) and the 95\% prediction intervals for one-step-ahead forecasts from our fitted SEIR models for each city.}
\label{fig:data}
\end{figure}

## Stochastic *SEIR* model
The model is a discrete-time approximation of a continuous-time SEIR model with limited demography, specified as a set of difference equations,

\begin{align}
S_{t+dt} &= n_{S,t} - n_{E,t} \\
E_{t+dt} &= n_{E,t} - n_{I,t} \\
I_{t+dt} &= n_{I,t} + n_{O,t} - n_{R,t},
\end{align}

\noindent{}where $\textbf{n}_t$ are random variables representing the number of individuals transitioning into or out of each class at each timestep $t \rightarrow t+dt$.
$n_{S}$ is the number of births, $n_{E}$ is the number of newly infected individuals that have the disease but are not infectious, $n_{I}$ is the number of newly infectious indiviuals, $n_{O}$ is the number of imported infections, and $n_{R}$ is the number of newly recovered individuals who are no longer infectious and have life-long immunity.
The stochastic random variables are specified as follows:

\begin{align}
n_{S,t} &\sim \text{Poisson}(\mu_t N_t \times dt) \\
n_{E,t} &\sim \text{Binomial}(\lambda_{E,t}, S_{t}) \\
n_{I,t} &\sim \text{Binomial}(\lambda_{I,t}, E_{t}) \\
n_{O,t} &\sim \text{Poisson}(\psi \times dt) \\
n_{R,t} &\sim \text{Binomial}(\lambda_{R,t}, I_{t}),
\end{align}

\noindent{}where $\mu_t$ is the birth rate at time *t*, $\psi$ is the rate of imported infections, and $\lambda_E$, $\lambda_I$, and $\lambda_R$ are the probabilities of exposure, becoming infectious, and recovery, respectively.
These probabilities reflect the processes of tranmission, transition from the latent period to the infectious period, and recovery, which we model as:

\begin{align}
\lambda_{E,t} &= 1 - e^{-\frac{\beta_t I_t dt}{N_t}} \\
\lambda_{I,t} &= 1 - e^{-\eta E_{t} dt} \\
\lambda_{R,t} &= 1 - e^{-\gamma I_{t} dt},
\end{align}

\noindent{}where $\beta_t$ is time-varying rate of transmission, $\eta$ is time-invariant rate from the exposed class to the infectious class, and $\gamma$ is time-invariant recovery rate.
We model rate of transmission as:

\begin{equation}
\beta_t = \beta \left(1 + \sum^6_{i=1} q_i \xi_{i_{t}} \right) \Gamma_t.
\end{equation}

$\beta$ is the mean transmission rate, $\psi$ accounts for measles infections from external sources that are not part of the local dynamics, and the term $\sum^6_{i=1} q_i \xi_{i_{t}}$ is a B-spline to model seasonality in transmission.
The B-spline bases ($\xi_{i_{t}}$) are periodic with a 1 year period.
The transmission rate ($\beta_t$) is also subject to stochastic process noise at each time step, $\Gamma_t$, which we model as a gamma-distributed white (temporally uncorrelated) noise with mean 1 and variance $\sigma^2$ [@Breto2011].

We do not include a death process in the model because the rate of infection is much faster than the rate of death.
Excluding deaths means we can avoid making further assumptions about demographic rates -- we are already making assumptions about birth rates (e.g., the rate is the same across cities, but with city-specific population size).
We model demographic stochasticity in births and imported infections by drawing time-specific values from Poisson distributions.
Transitions in the model are shown in Table 1.
In this model, the effective reproductive ratio at time *t* is: $R_E(t) = \frac{\beta_t}{\gamma} \frac{S_t}{N_t}$.

We assume observed case reports ($\textbf{y}$) are drawn from a Negative Binomial distribution subject to a constant reporting fraction ($\rho$) and dispersion parameter $\tau$,

\begin{align}
y_t \sim \text{Negative Binomial} \left( \rho I_t, \tau \right).
\end{align}

| Transition | ($\Delta S$, $\Delta E$, $\Delta I$) | Propensity |
| --------------- | ------------ | -------------------------------------------- |
| birth | $(1, 0, 0)$ | $N_t \mu_t$ |
| transmission (deterministic) | $(-1, 1, 0)$ | $SI \beta_t / N_t$ |
| transmission (stochastic) | $(-k, k, 0)$ | $\frac{S}{k}\sum^k_{j=0} \left(\begin{matrix}k\\j\end{matrix} \right) (-1)^{k-j+1} \tau_{\text{f}}^{-1} \text{ln}(1 + (\beta_tI/N_t)) \tau_{\text{f}} (S-j)$ |
| symptomatic (infectious) | $(0,-1,1)$ | $E\eta$
| imported infections | $(0, 0, 1)$ | $\psi_t$ |
| recovery | $(0, 0, -1)$ | $I\gamma$ |

Table: Transitions in the SEIR model. We show the determinstic transmission rate for clarity, but our model uses the stochastic tranmission rate.

##  Model fitting and inference

We fit the SEIR model to time series of case reports from each of our focal cities using Maximization by Iterated particle Filtering (MIF).
We estimated 14 parameters for each city: six seasonal transmission parameters ($q_i$), mean transmission rate ($\beta$), three initial conditions $\left(S_{(t=0)},E_{(t=0)},I_{(t=0)}\right)$, the number of imported infections ($\psi$), reporting fraction ($\rho$), one parameter accounting for process noise ($\sigma$), and one parameter accounting for measurement noise ($\tau$).
To ensure identifiability, and to make the model easier to fit, we assumed the infectious period was fixed at $1/\eta = 8$ days and the recovery period was fixed at $1/\gamma = 5$ days.
The birth rate ($\mu_t$) was multiplied by 0.3 to account for the reported 70\% vaccination coverage [@Ferrari2008].

MIF relies on particle filtering, which estimates the likelihood of fixed parameters by integrating state variables of a stochastic system.
To narrow in on the maximum likelihood estimates, MIF lets parameters take a random walk during the filtering process and selectively propagates forward parameter sets (i.e., particles) with the highest likelihood.
The variance of the random walk decreases at each iteration of MIF, where a MIF iteration means one filtering pass through the time series.
This procedure converges toward the maximimum likelihood estimates (MLEs), in theory.

We used the IF2 algorithm [@Ionides2015] implemented in the R [@R2017] package `pomp` [@King2016; @King2018] to conduct the MIF procedure.
To initialize MIF, we generated 5000 parameter sets using Latin Hypercube Sampling over large ranges of the parameter values.
We then performed two rounds of MIF, each for 100 iterations, with 10000 particles, and geometric cooling.
For the first round of MIF we set `cooling.facter = 1`.
For the second round, which was initialized using the collection of parameter sets from the end of the first round, we set `cooling.factor = 0.9`.
We computed the log likelihood of 5000 final MIF parameter sets (i.e., parameter sets collected after 200 MIF iterations) as the log of the mean likelihoods of 50 replicate particle filters with 10000 particles each.
At this stage, we assume the parameter set with highest log likelihood is the MLE.

We used profiling to estimate 95\% confidence intervals for four parameters of interest: mean transmission rate ($\beta$), the initial fraction of susceptible individuals $\left(S_{(t=0)}\right)$, the number of imported infections ($\psi$), and reporting fraction ($\rho$).
For each parameter, we profiled over a range of 100 values using the same MIF and likelihood estimate procedure as described above for finding the MLEs.
We replicated the profiling procedure 10 times for each unique value of the focal parameter and then took the log of the mean of those 10 profiled likelihoods.
These values were used to estimate 95\% confidence intervals using the Monte Carlo-adjusted profile algorithm described by @Ionides2017.

## Model simulations

We used the MLE parameter sets to make one-step-ahead predictions, to estimate any trend in transmission rate through time, and to test the ability of early warning signals to anticipate the critical transition at $R_E(t) = 1$.
To make one-step-ahead predictions, we used particle filtering with 50000 particles and retained the mean and standard deviation of all latent across all particles before they were filtered at each time step.
To estimate a trend in tranmission rate, we allowed mean transmission to take a random walk throughout the filter and retained the filtered distribution of particles for mean transmission and $R_E(t$).

We manipulated the initial size of the susceptible pool to simulate an increase from low $R_E(t)$ to high $R_E(t)$.
Doing so allows us to test whether EWS can distinguish between windows of time when $R_E(t)$ is far from a critical transition and when $R_E(t)$ is near a critical transition.
We reduced the initial fraction of susceptible individuals by multplying the MLE for $S_{(t=0)}$ by six discounting factors: 1e-4, 0.1, 0.2, 0.3, 0.4, and 0.5.
These discounting factors represent situations of susceptible depletion after outbreaks of various size.
We then simulated the model forward for thirty years using mean birth and death rates for the entire country.
Thirty years was long enough for yearly average $R_E(t)$ to reach 1 for each city.
Because the model is stochastic, we repeated these simulations 500 times for each city-susceptible discount combination.

Next, we split each simulated time series into null and test intervals.
First, across all simulations for a city-susceptible discount combination, we found the simulation year in which yearly average $R_E(t)$ reached 1, and excluded years past that time.
We split the remaining time series into two windows of equal length.
The null interval is the first window, where $R_E(t)$ is increasing but far from 1.
The test interval is the second window, where $R_E(t)$ is increasing and approaching 1.
We did this for each city and for each level of susceptible depletion.
We calculated EWS over null and test intervals separately, as described next.

## Early warning signals

We considered ten candidate early warning signals.
We used the `spaero::get_stats()` function [@ODea2018] in R [@R2017] to calculate EWS according to the formulas in Table 3.
All EWS except the coefficient of variation are expected to increase as $R_E(t)$ approaches 1 [@Brett2018].
However, we still inlcude the coefficient of variation becuase it is often used EWS in other applications.

For each simulation of each city-susceptible discount combination, we calculated each EWS for the time series of expected cases in the null and test intervals.
This yields a distrbution of EWS over the 500 null and test intervals.
The bandwidth for EWS calculation varied because we set $b$ to be one-half the length of the interval.
That is, we do not use a moving window and if, for example, the length of the interval is 10 years, then $b = 0.5\times 10 = 5$.

We assessed the performance of each EWS using the Area Under the Curve (AUC) statistic.
Specifically, we use AUC to calculate the amount of overlap between the distributions of each EWS from the null and test intervals.
Higher values of AUC indicate a greater degree of separation and thus better performance of a particular EWS in terms of classifying whether $R_E(t)$ is approaching a critical transition.
We used the `pROC:auc()` function [@Robin2011] in R to calculate AUC values.


| EWS | Estimator | Theoretical Correlation with $R_E(t)$ |
| -------------------- | ----------------------------------- | ------------------------ |
| Mean | $\mu_t = \sum^{t+(b-1)\delta}_{s=t-(b-1)\delta} \frac{X_s}{2b-1}$ | Positive |
| Variance | $\sigma_t^2 = \sum^{t+(b-1)\delta}_{s=t-(b-1)\delta} \frac{\left(X_s - \mu_s\right)^2}{2b-1}$ | Positive |
| Coefficient of variation | $CV_t = \frac{\sigma_t}{\mu_t}$ | Null |
| Index of dispersion | $ID_t = \frac{\sigma_t^2}{\mu_t}$ | Positive |
| Skewness | $S_t = \frac{1}{\sigma^3_t} \sum^{t+(b-1)\delta}_{s=t-(b-1)\delta} \frac{\left(X_s - \mu_s\right)^3}{2b-1}$ | Positive |
| Kurtosis | $K_t = \frac{1}{\sigma^4_t} \sum^{t+(b-1)\delta}_{s=t-(b-1)\delta} \frac{\left(X_s - \mu_s\right)^4}{2b-1}$ | Positive |
| Autocovariance | $\text{ACov}_t = \sum^{t+(b-1)\delta}_{s=t-(b-1)\delta} \frac{\left(X_s - \mu_s\right)\left(X_{s-\delta} - \mu_{s-\delta}\right)}{2b-1}$ | Positive |
| Autocorrelation | $\text{AC}_t = \frac{\text{ACov}_t}{\sigma_t \sigma_{t-\delta}}$ | Positive |
| Decay time | $\overline{\tau}_t = -\delta / \text{ln}\left[\text{AC}_t(\delta)\right]$ | Positive |
| First differenced variance | $\Delta\sigma_t^2 = \sigma_t^2 - \sigma_{t-\delta}^2$ | Positive |

Table: List of candidate early warning signals and their estimating equations. Note that *b* denotes the bandwidth. See @Brett2018 for details.

# Results

## Model fit

The fitted models adequately reproduced observed dynamics (Figure 1), with in-sample $R^2$s ranging from 0.54 for Agadez to 0.89 for Maradi (Figure \ref{fig:scatters}).
Stochastic simulations of the models displayed dynamics typical of each city (Figure Sx), including the decline in seasonality amplitude as population size decreases [Figure Sx; @Ferrari2008].
Our model for Agadez performs poor

\begin{figure}[!ht]
\centering
\includegraphics[width=\textwidth]{../figures/pred-obs-scatters.pdf}
\caption{Comparison of in-sample model predictions and observations for each city. Expected cases are one-step-ahead predictions from the fitted models. The dashed line shows 1:1.}

\label{fig:scatters}
\end{figure}

Stochastic simulations from sub-critical ($R_E(t) \ll 1$) to critical dynamics ($R_E(t) = 1$) differed among the four cities (Figure \ref{fig:re-sims}).

```{r mles, warning=FALSE, message=FALSE, results='asis', echo=FALSE}
library(tidyverse)
library(dplyr)
library(xtable)

options(xtable.comment = FALSE)

result_files <- list.files("../results/")
mle_files <- result_files[grep("initial-mif-lls", result_files)]

mles <- tibble()
for(do_file in mle_files){
  tmp <- read.csv(paste0("../results/", do_file)) %>%
    drop_na() %>%
    filter(loglik == max(loglik)) %>%
    dplyr::select(loglik, loglik_se, beta_mu, beta_sd, iota, rho, S_0) %>%
    gather() %>%
    mutate(city = str_sub(do_file, 17, (nchar(do_file)-4)))
  
  mles <- bind_rows(mles, tmp)
}

mles_table <- mles %>%
  spread(key = key, value = value) %>%
  arrange(city) %>%
  mutate(
    loglik_and_se = paste0(round(loglik,2), " (", round(loglik_se,2), ")")
  ) %>%
  dplyr::select(city, loglik_and_se, beta_mu, beta_sd, iota, rho, S_0) %>%
  dplyr::rename(
    City = city,
    `Log likelihood (S.E.)` = loglik_and_se,
    `$\\beta$` = beta_mu,
    `$\\sigma$` = beta_sd,
    `$\\psi$` = iota,
    `$\\rho$` = rho,
    `$\\textsl{S}_{t=0}$` = S_0
  )

print(xtable::xtable(mles_table, digits = 2, caption = "Maximum likelihood estimates for select epidemiological parameters."), caption.placement = "top", include.rownames = F, sanitize.colnames.function = identity)

```

\begin{figure}[!ht]
\centering
\includegraphics[width=\textwidth]{../figures/re-simulated-series-grid.pdf}
\caption{Yearly average $R_E(t)$ (blue lines) across 500 models simulations at the MLE parameters and 20 representations simulations (grey lines) for each city. The horizontal dashed line shows where $R_E(t) = 1$. The vertical solid red lines show the time point at which yearly average $R_E(t) \ge 1$. The time periods before the red line for each city were used for testing early warning signals.}
\label{fig:re-sims}
\end{figure}

\begin{figure}[!ht]
\centering
\includegraphics[width=\textwidth]{../figures/simulation-grid-aucs.pdf}
\caption{Performance of EWS calculated over two windows (far from and near $R_E(t) = 1$) from the time series of 500 simulated dynamics, shown as a heatmap of AUC values minus 0.5. The two windows were defined as equally-sized windows over the course of the time series up to $R_E(t) = 1$ (red lines in Figure \ref{fig:re-sims}). The asterisks (*) in the heatmap for Niamey note EWS with high AUC, but for the wrong reason: skewness and kurtosis \emph{decrease} as $R_E(t)$ approaches 1 rather than increase. This occurs because of the negative binomial sampling in the measurement component of our SEIR model.}
\label{fig:aucs}
\end{figure}


\nolinenumbers

# Acknowledgments
This research was funded by the National Institute of General Medical Sciences of the National Institutes of Health (Award Number U01GM110744).
The funders had no role in study design, data collection and analysis, decision to publish, or preparation of the manuscript.
This work was done on the Olympus High Performance Compute Cluster located at the Pittsburgh Supercomputing Center at Carnegie Mellon University, which is supported by National Institute of General Medical Sciences Modeling Infectious Disease Agent Study (MIDAS) Informatics Services Group grant 1U24GM110707.

# References
