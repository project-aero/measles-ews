---
title: 'PROTOCOL FOR:'
subtitle: Linking early warning signals to the temporal epidemiology of measles in
  Nigerien cities
author: "Andrew Tredennick (atredenn@gmail.com)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: default
  pdf_document:
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(tidyverse)
library(ggthemes)
library(pomp)
library(lubridate)

theme_set(theme_minimal())
```

## Authors
+ Andrew Tredennick
+ Eamon O'Dea
+ Pejman Rohani
+ John Drake


## Background
Theory shows that epidemic transitions can be anticipated by trends in the statistical properties of disease time series (AERO papers).
The existence of statistical trends in the data that precede critical transitions, so-called 'early warning signals' (EWS), imply that we may be able to anticipate disease emergence and outbreaks.
The end goal is a model-independent detection system, where statistical properties of disease surveilence data can trigger warnings of impending outbreaks without the need to fit mechanistic models of disease transmission (Han and Drake 2017).

However, there is currently a gap between the theoretical work, which has relied on knowing the underlying disease dynamics, and the eventual goal of applying EWS in real-world situations where the underlying disease dynamics may be unknown.
Theoretical development of EWS has focused on anticipating when the population becomes supercritical, when $\mathcal{R}_0 > 1$, after which an outbreak is inevitable, perhaps with some bifurcation delay (Dibble et al. 2016).
Knowing the value of $\mathcal{R}_0$ through time makes it possible to test the accuracy of EWS that are estimated from state variables alone.
Empirical application of EWS does not require knowing the value of $\mathcal{R}_0$ through time, meaning that "tests" require making assumptions about when critical transitions occur.
Whether EWS track and/or anticipate underlying dynamics of real disease time series remains unknown, and is a critical knowledge gap that must be filled before EWS can confidently be deployed.

To fill this gap we will fit a mechanistic model to incidence data of measles in Niger to estimate the temporal epidemiology of the disease, yielding the very same parameters that are known in data-free modeling studies.
In particular, we are interested in the correlation between EWS and the time-varying repreoductive ratio, known as the effective reprodutive ratio $\left(\mathcal{R}_E\right)$.
If EWS and $\mathcal{R}_E$ are significantly and positively correlated, then we have empirical evidence that EWS are applicable in real-world settings.
If EWS and $\mathcal{R}_E$ are negatively correlated or not significantly posivitely correlated, then we have evidence that EWS may not be applicable in certain settings.

## Research questions
1. Do model-independent early warning signals *track* and/or *anticipate* the effective reproductive ratio?
2. Do some early warning signals outperform others in terms of their ability to track or anticipate the effective reproductive ratio?
3. Does the degree to which early warning signals track or anticipate the effective reproductive ratio depend on the magnitude or dynamics of the effective reproductive ratio itself? For example, the temporal correlation between an EWS and $\mathcal{R}_E$ might be weak when $\mathcal{R}_E < 1$, where the dynamics are subcritial and the observed time series is mainly driven by environmental or demographic stochasticity.

## Study design
### I. Fit a mechanistic SIR model to measles incidence data from 4 cities in Niger

The goal is fit a model to estimate:

 + The latent *S*, *I*, and *R* latent states
 + Time-varying rate of transmision, $\beta_t$
 + Time-varying effective reproductive ratio, $\mathcal{R}_{E(t)}$
 

#### The mechanistic SIR model
    
The model is a continuous time SIR model with limited demography, specified as a set of stochastic differential equations (SDEs):

\begin{align}
dS &= \mu_t N_t dt - \lambda_t S_t dt + dW_t \\
dI &= \lambda_t S_t dt - \gamma I_t dt + dW_t \\
dR &= \gamma I_t dt + dW_t,
\end{align}

\noindent{}where $\mu_t$ is birth rate at time *t*, $\gamma$ is the time-invariant recovery rate, and $\lambda_t$ is the time-varying force of infection.
We do not include a death process in the model because we expect death rates from the susceptible and infectious classes to be minimal relative to births and we are not interested in robust estimates of the recovered class.
Excluding deaths means we can avoid making further assumptions about demographic rates -- we are already making assumptions about birth rates (e.g., the rate is the same across cities, but with city-specific population size).
Transitions in the model are shown in Table 1.
We model $\lambda_t$ as a function of a seasonal tranmission rate subject to additional environmental variability through time:

\begin{align}
\lambda_t &= \frac{\beta_t (I_t + \psi)}{N_t}, \\
\beta_t &= \beta \left(1 + \sum^6_{i=1} q_i \xi_{i_{t}} \right) \Gamma_t, 
\end{align}

\noindent{}where $\beta_t$ is the rate of transmission at time *t*, $\beta$ is the mean transmission rate, $\psi$ accounts for measles infections from external sources that are not part of the local dynamics, and the term $\sum^6_{i=1} q_i \xi_{i_{t}}$ is a B-spline to model seasonality in transmission.
The B-spline bases ($\xi_{i_{t}}$) are periodic with a 1 year period.
The transmission rate ($\beta_t$) is also subject to stochastic process noise at each time step, $\Gamma_t$, which we model as a gamma-distributed white (temporally uncorrelated) noise with mean 1 and variance $\sigma^2$ (BretÃ³ and Ionides 2011).
In this model, the effective reproductive ratio at time *t* is: $\mathcal{R}_{E(t)} = \beta_t / \gamma$.

We assume observed case reports ($\textbf{y}$) are drawn from a negative binomial distribution subject to a constant reporting fraction ($\rho$) and dispersion parameter $\tau$,

\begin{align}
y_t \sim \text{NegBin} \left( \rho I_t, \tau  \right).
\end{align}

| Transition | ($\Delta S$, $\Delta I$, $\Delta R$) | Propensity |
| --------------- | ------------ | -------------------------------------------- |
| birth | $(1, 0, 0)$ | $N_t \mu$ |
| transmission (deterministic) | $(-1, 1, 0)$ | $S(I+\psi) \beta_t / N_t$ |
| transmission (stochastic) | $(-k, k, 0$) | $\frac{S}{k}\sum^k_{j=0} \left(\begin{matrix}k\\j\end{matrix} \right) (-1)^{k-j+1} \tau_{\text{f}}^{-1} \text{ln}(1 + (\beta_t(I+\psi)/N_t)) \tau_{\text{f}} (S-j)$ |
| recovery | $(0, -1, 1)$ | $I\gamma$ |

Table: Transitions in the SIR model. We show the determinstic transmission rate for clarity, but our model uses the stochastic tranmission rate.


#### Model fitting

We will fit the model to data via iterated filtering to maximize the likelihood, as implemented in the R package `pomp`.
We seek to estimate 14 parameters for each city (Table 2).

| Parameter | Description |
| --------- | ----------- |
| $\beta$ | Mean rate of transmission |
| $\gamma$ | Constant rate of recovery |
| $\rho$ | Constant reporting fraction |
| $q_i$ for $i \in \{1,2,3,4,5,6\}$ | B-spline coefficients for seasonality |
| $\psi$ | External infections |
| $\sigma^2$ | Variance of gamma-distributed environmental noise |
| $S_0$ | Initial conditions for susceptible class |
| $I_0$ | Initial conditions for infected class |
| $R_0$ | Initial conditions for recovered class |

Table: List of model parameters to be estimated.

Model fitting will proceed in three steps, independently for each city:
 
1. Generate initial parameter sets from a large Latin hypercube search space of 5000 parameter sets. Run 10 replicate particle filters at each of these parameter sets, with 2000 particles each. Retain the 500 parameter sets with the highest likelihood.

2. Conduct a global parameter search using the retained 500 parameter sets from above (the 500 with the highest likelihood). This parameter set will serve as starting conditions for 500 instances of iterated filtering using the function:
```{r pomp-ex, eval = FALSE, echo = TRUE}
pomp::mif2(Np = 2000, Nmif = 50, cooling.fraction.50 = 1, cooling.type = "geometric")
```
and initial parameter conditions allowed to take random walks with a standard deviation of 0.02.
For states (i.e., $S_0, I_0, R_0$), we will set the initial conditions random walk standard deviation to 0.1 and the random walk will stop after 1 year (52 weeks) of the simulated dynamics.

3. Conduct a local parameter search using the the 50 parameter sets from the global search with the highest likelihoods. MIF parameters will be the same as above, except the cooling factor will be `cooling.fraction.50 = 0.9`. We will consider the parameter set with the highest likelihood at this stage to be the MLEs ($\hat{\theta}$).

4. To complete our inference from the model, we will perform particle MCMC using $\hat{\theta}$ as the initial conditions. The MCMC analysis allows us to estimate the uncertainty around all parameters and to generate estimates of the latent states and the $\mathcal{R}_E$ for the observed data. That is, we will end up with a time series of $\mathcal{R}_E$, including uncertainty, that corresponds to the observation time series.
    - Can we just get this from `pfilter(save.states)`?

### II. Calculate a suite of EWS from the observed data
We will consider 10 candidate EWS (Table 3).
The EWS will be calculated using the function `spaero::get_stats()` in R for each of the case report time series shown in Figure 1 (below).
We will use a "backward looking" bandwidth of 52 weeks.
"Backward looking" means that the rolling window over which the EWS are calculated covers the 35 weeks prior to the focal time point *t*, rather than the window being centered on *t*.

| EWS | Estimator | Theoretical Correlation with $\mathcal{R}_E(t)$ |
| -------------------- | ----------------------------------- | ------------------------ |
| Mean | $\mu_t = \sum^{t+(b-1)\delta}_{s=t-(b-1)\delta} \frac{X_s}{2b-1}$ | Positive |
| Variance | $\sigma_t^2 = \sum^{t+(b-1)\delta}_{s=t-(b-1)\delta} \frac{\left(X_s - \mu_s\right)^2}{2b-1}$ | Positive |
| Coefficient of variation | $CV_t = \frac{\sigma_t}{\mu_t}$ | Null |
| Index of dispersion | $ID_t = \frac{\sigma_t^2}{\mu_t}$ | Positive |
| Skewness | $S_t = \frac{1}{\sigma^3_t} \sum^{t+(b-1)\delta}_{s=t-(b-1)\delta} \frac{\left(X_s - \mu_s\right)^3}{2b-1}$ | Positive |
| Kurtosis | $K_t = \frac{1}{\sigma^4_t} \sum^{t+(b-1)\delta}_{s=t-(b-1)\delta} \frac{\left(X_s - \mu_s\right)^4}{2b-1}$ | Positive |
| Autocovariance | $\text{ACov}_t = \sum^{t+(b-1)\delta}_{s=t-(b-1)\delta} \frac{\left(X_s - \mu_s\right)\left(X_{s-\delta} - \mu_{s-\delta}\right)}{2b-1}$ | Positive |
| Autocorrelation | $\text{AC}_t = \frac{\text{ACov}_t}{\sigma_t \sigma_{t-\delta}}$ | Positive |
| Decay time | $\overline{\tau}_t = -\delta / \text{ln}\left[\text{AC}_t(\delta)\right]$ | Positive |
| First differenced variance | $\Delta\sigma_t^2 = \sigma_t^2 - \sigma_{t-\delta}^2$ | Positive |

Table: List of candidate early warning signals and their estimating equations. Note that *b* denotes the bandwidth. See Brett et al. (2018) for details.


### III. Calculate the correlation between EWS lags and $\left(\mathcal{R}_E\right)$
Answering our [Research questions] requires calculating the correlation between each EWS and $\mathcal{R}_E$ through time.
We are interested in the correlation between EWS and $\mathcal{R}_E$ because these correlations tell us whether a particular EWS can anticipate a change in $\mathcal{R}_E$.
We will calculate the temporal correlation of $[\text{EWS}(t), \mathcal{R}_E(t)]$ for all EWS with Spearman's $\rho$ using the R function `cor(..., method = "spearman")`.
Pearson's correlation coefficient is not suitable for testing nonlinear associations and Kendall's $\tau$ does not take into account the distance between discordant pairs, so we will use Spearman's rank correlation.[^1] 
As shown in Table 2, we expect all EWS to positively covary with $\mathcal{R}_E$ over time, a prediction we can test by calculating the correlations and their significance using the function `cor.test(..., method = "spearman")`.

[^1]: Note that Spearman's $\rho$ does not handle ties very well, so we may have to fall back on Kendall's $\tau$ is there are many ties and we do not want to rely on approximate p-values.

There often exists a lag between when the dynamical system goes critical and when an outbreak or epidemic occurs, so-called bifucation delay (Dibble et al. 2016).
Therefore, EWS that correlate well with underlying dynamics (i.e., $\mathcal{R}_E(t)$) should be useful for anticipating outbreaks.

## Data sources

```{r data-example, fig.height=3, fig.width=10, fig.cap="Time series of weekly measles case reports from four cities in Niger."}
file_name <- "../../data/raw-data/niger_regional_1995_2005.csv"
niger_measles_raw <- read_csv(file_name, col_types = cols())

num_regions <- nrow(niger_measles_raw)
num_weeks <- ncol(niger_measles_raw) - 1  # subtract 1 from ncol() because first column are regions
weeks_per_year <- num_weeks/11
weeks <- rep(1:52, times = 11)

# Create a vector of years for all num_weeks
years <- rep(1995:2005, each = weeks_per_year)

# Function for calculating start of week based on week number and year
calculate_start_of_week = function(week, year) {
  date <- ymd(paste(year, 1, 1, sep="-"))
  week(date) = week
  return(date)
}

# Clean up the data frame
measles_data <- niger_measles_raw %>%
  gather(key = week, value = cases, -X1) %>%
  mutate(
    week_num = rep(1:num_weeks, each = num_regions),
    year = rep(years, each  = num_regions),
    week = rep(weeks, each = num_regions),
    date = calculate_start_of_week(week, year)
  ) %>%
  dplyr::rename(region = X1) %>%
  filter(grepl("City", region))

ggplot(measles_data, aes(x = date, y = cases, color = region)) +
  geom_path() +
  facet_wrap(~region, scales = "free_y", nrow = 1) +
  scale_color_manual(values = ptol_pal()(4)) +
  guides(color = FALSE)
```


We will use weekly measles case report data from four Nigerien cities, collected over an 11 year period (1995-2005) (Figure 1).
These data are ideal for stress testing EWS because each city has different population sizes, has different dynamics in terms of size of outbreaks and length of inter-epidemic periods, and each time series has different amounts of "noise" (though, the difference in variability is probably just reflective of population size differences).
The data come from [*somewhere/someone*], and used here with permission from [*somewhere/someone*].

## Analysis and expected results
The results will start with a figure of example time series of $\mathcal{R}_E$ and an EWS (e.g., variance), as well as a scatterplot of their correlation (all in one multipanel plot, e.g., Figure 1).

```{r time-series-ex, fig.height=5, fig.width=10, fig.cap= "Time series of $\\mathcal{R}_E$ and the variance of case reports (a). Scatterplot showing the correation between $\\mathcal{R}_E$ and the variance of case reports (b)."}
ntimes <- 500
N <- numeric(500)
N[1] <- 0
for(i in 2:ntimes){
  N[i] <- 0.2 + 0.9*N[i-1] + rnorm(1,0,1)
}
N[N<0] <- 0

plot_tbl <- tibble(
  time = 1:ntimes,
  Re = N,
  Variance = spaero::get_stats(N, center_bandwidth = 52, stat_bandwidth = 52)[["stats"]][["variance"]]
) %>%
  gather(key = variable, value = value, -time)

g1 <- ggplot(plot_tbl, aes(x = time, y = value)) +
  geom_line() +
  facet_wrap(~variable, ncol = 1, scales = "free_y") +
  geom_hline(aes(yintercept = 1, color = variable)) +
  scale_color_manual(values = c(ptol_pal()(2)[2], NA))

scatter_data <- plot_tbl %>%
  spread(key = variable, value = value)

g2 <- ggplot(scatter_data, aes(x = Variance, y = Re)) +
  geom_point()

cowplot::plot_grid(g1, g2, ncol = 2, align = "h", labels = "auto")

```

The main figure will show the correlation between each EWS and $\mathcal{R}_E$ for each city (Figure 2).
Figure 2 answers question one (see [Research questions]): do EWS track and/or anticipate $\mathcal{R}_E$?
If, in general, correlations are significant and positive, as expected by theory, then the answer is "yes."
If, in general, correlations are weak (not significant), null, or negative, then the answer is "no."
We can also indicate which correlations are significant, either in this figure or in a supplementary table.


```{r plot-ex, fig.height=3, fig.width=4, fig.cap="Heatmap of temporal correlations of EWS and $R_E$ through time for each city."}
ncities <- 4
cities <- c("Agadez", "Maradi", "Niamey", "Zinder")
news <- 10 
ews <- c("Mean", "Variance", "CV", "ID", "Skew", "Kurt", "Acov", "AC", "Tau", "FDV")
lags <- 11
mean_rhos <- (seq(sqrt(0.000001),sqrt(0.9),length.out = lags))^2
out <- tibble()
for(i in 1:ncities){
  for(j in 1:news){
    tmp_corrs <- rnorm(lags, mean_rhos, mean_rhos*0.2)
    tmp_corrs[tmp_corrs > 1] <- 1
    tmp_corrs[tmp_corrs < 0] <- 0
    outtmp <- tibble(
      city = cities[i],
      ews = ews[j],
      lag = 0:(lags-1),
      correlations = rev(tmp_corrs)
    )
    out <- rbind(out, outtmp)
  }
}

out <- out %>%
  filter(lag == 0)

library(viridis)

ggplot(out, aes(x = city, y = ews, fill = correlations)) +
  geom_tile() +
  scale_fill_viridis(name = expression(paste("Kendell's ", tau))) +
  labs(x = "City", y = "Early warning signal")

# ggplot(out, aes(lag, correlations)) +
#   geom_point(aes(color = as.factor(ews))) +
#   stat_smooth(aes(color = as.factor(ews)), se = FALSE, size = 0.5) +
#   facet_wrap(~as.factor(city), nrow = 1) +
#   scale_color_manual(values = ptol_pal()(10), name = NULL) +
#   scale_x_continuous(breaks = 0:10) +
#   theme(legend.position = "top") +
#   labs(x = "Time lag (weeks)", y = expression(paste("Kendell's ", tau)))

```

The second question, "Do some EWS outperform others?", will be answered by simply ranking each EWS by correlation strength (also visible in Figure 2).

The third question, "Does the degree to which early warning signals track or anticipate the effective reproductive ratio depend on the magnitude or dynamics of the effective reproductive ratio itself?", will be answered by conducting a *post hoc* statistical analysis.
First, the $\mathcal{R}_E(t)$ time series will be broken up into clusters according to whether $\mathcal{R}_E(t) > 1$ or not.
Then, we will run the correlation analysis seperately for each cluster (e.g., a single time series might have 10 sections where R < 1, and 10 sections where R > 1, yielding a sample size of 20 time series).
Lastly, we will conduct an ANOVA to determine if the threshold value of $\mathcal{R}_E$ determines the correlation between EWS$_t$ and $\mathcal{R}_E(t)$.
One expectation is that the correlation will be low/weak when $\mathcal{R}_E \lessapprox 1$ but high/strong when $\mathcal{R}_E \gtrapprox 1$.
An example figure is shown below (Figure 3), in which whether $\mathcal{R}_E(t)$ is above/below the threshold of 1 does impact its correlation with each EWS.

```{r anova-fig, fig.height=4, fig.width=10, fig.cap="Boxplots of temporal correlations between EWS and $R_E$ through time, split apart by the value of $R_E$."}
ntimes <- 20
plotit <- tibble(
  city = rep(unique(measles_data$region), each = ntimes*length(ews)),
  ewss = rep(ews, times = ntimes*4),
  rnaught = rep( rep(c("> 1", "< 1"), each = 10), times = 4*length(ews))
) %>%
  group_by(city, ewss) %>%
  mutate(
    correlations = ifelse(rnaught == "> 1", rnorm(ntimes*length(ews), 0.8, 0.1), rnorm(ntimes*length(ews), 0.2, 0.1))
  )

ggplot(plotit, aes(x = rnaught, y = correlations)) +
  geom_boxplot(aes(fill = ewss)) +
  facet_wrap(~city, nrow = 1, scales = "free_y") +
  scale_fill_manual(values = ptol_pal()(10), name = NULL) +
  scale_y_continuous(limits = c(-0.1, 1)) +
  theme(legend.position = "top") +
  labs(x = expression(R[E]), y = expression(paste("Kendell's ", tau)))
```

## Checklist

+ ~~Create cleaned dataset of just the four focal cities from Niger~~
+ ~~Write R code to define the `pomp` model object (SDE)~~
+ Simulate time series from the `pomp` object with parameters that give us irregular dynamics like the observed data
+ Do test analysis of steps II-III using the simulated data
+ Perform iterated filter parameter search for MLEs
    - ~~Get set up on UGA cluster~~
    - ~~Get set up on MIDAS cluster~~
+ ~~Calculate EWS on the observed data~~
    - Work with Eamon on bandwidth, etc.
+ Caclulate correlations with real data and empirically-derived $\mathcal{R}_E$ and lags
+ Write the paper!

