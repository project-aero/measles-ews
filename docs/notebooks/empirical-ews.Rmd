---
title: "EWS in measles data"
output: html_notebook
---

I use the `spaero::get_stats()` function to calculate EWS over a moving window for the measles case incidence data from four cities in Niger.
I use a bandwidth of 35 weeks, resulting in a `r 35*2` week window.
All EWS are calculated with `backward_only = TRUE` so that EWS are only calculated based on data in the past.

```{r calc-ews}
# Load packages -----------------------------------------------------------

library(tidyverse)
library(spaero)


# Load data ---------------------------------------------------------------

fname <- "../../data/clean-data/weekly-measles-incidence-niger-cities-clean.RDS"
measles_data <- readRDS(fname) %>%
  filter(year > 1994)  # drop first NA year, only used for modeling


# Calculate EWS -----------------------------------------------------------

all_stats <- tibble()  # empty tibble for storage

for(do_region in unique(measles_data$region)){
  
  cases <- measles_data %>%
    filter(region == do_region) %>%
    pull(cases)
  
  city_stats <- spaero::get_stats(
    x = cases,
    center_trend = "local_constant", 
    center_kernel = "uniform", 
    center_bandwidth = 35, 
    stat_trend = "local_constant", 
    stat_kernel = "uniform", 
    stat_bandwidth = 35, 
    lag = 1, 
    backward_only = TRUE
  )$stats
  
  city_stats_tb <- as_tibble(city_stats) %>%
    mutate(
      time_iter = 1:n(),
      date = unique(measles_data$date)
    ) %>%
    gather(key = ews, value = value, -time_iter, -date) %>%
    mutate(region = do_region)
  
  all_stats <- bind_rows(all_stats, city_stats_tb)
}

```

Define a function to plot the EWS and the observations.

```{r plot-ews-func}
plot_it <- function(dates, cases, ews, lab, title){
  par(mar = c(5,5,2,5))
  plot(dates, cases, type = "l", main = title)
  par(new = T)
  plot(dates, ews, type = "l", col = "red", axes=F, xlab=NA, ylab=NA)
  axis(side = 4)
  mtext(side = 4, line = 3, lab, cex = 0.7)
}
```

### Agadez

```{r agadez, fig.height=8}
do_region <- "Agadez (City)"
dates <- unique(measles_data$date) 
par(mfrow = c(4,3))
for(do_ews in unique(all_stats$ews)){
  cases <- filter(measles_data, region == do_region) %>% pull(cases)
  ews <- filter(all_stats, region == do_region & ews == do_ews) %>% pull(value)
  plot_it(dates, cases, ews, lab = "ews", title = do_ews)
}
```

### Maradi
```{r maradi, fig.height=8}
do_region <- "Maradi (City)"
dates <- unique(measles_data$date) 
par(mfrow = c(4,3))
for(do_ews in unique(all_stats$ews)){
  cases <- filter(measles_data, region == do_region) %>% pull(cases)
  ews <- filter(all_stats, region == do_region & ews == do_ews) %>% pull(value)
  plot_it(dates, cases, ews, lab = "ews", title = do_ews)
}
```

### Niamey
```{r niamey, fig.height=8}
do_region <- "Niamey (City)"
dates <- unique(measles_data$date) 
par(mfrow = c(4,3))
for(do_ews in unique(all_stats$ews)){
  cases <- filter(measles_data, region == do_region) %>% pull(cases)
  ews <- filter(all_stats, region == do_region & ews == do_ews) %>% pull(value)
  plot_it(dates, cases, ews, lab = "ews", title = do_ews)
}
```

### Zinder
```{r zinder, fig.height=8}
do_region <- "Zinder (City)"
dates <- unique(measles_data$date) 
par(mfrow = c(4,3))
for(do_ews in unique(all_stats$ews)){
  cases <- filter(measles_data, region == do_region) %>% pull(cases)
  ews <- filter(all_stats, region == do_region & ews == do_ews) %>% pull(value)
  plot_it(dates, cases, ews, lab = "ews", title = do_ews)
}
```

