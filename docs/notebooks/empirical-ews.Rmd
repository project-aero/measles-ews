---
title: "EWS in measles data"
output: html_notebook
---

I use the `spaero::get_stats()` function to calculate EWS over a moving window for the measles case incidence data from four cities in Niger.
I use a bandwidth of 35 weeks, resulting in a `r 35*2` week window.
All EWS are calculated with `backward_only = TRUE` so that EWS are only calculated based on data in the past.

```{r calc-ews}
# Load packages -----------------------------------------------------------

library(tidyverse)
library(spaero)


# Load data ---------------------------------------------------------------

fname <- "../../data/clean-data/weekly-measles-incidence-niger-cities-clean.RDS"
measles_data <- readRDS(fname) %>%
  filter(year > 1994)  # drop first NA year, only used for modeling


# Calculate EWS -----------------------------------------------------------

all_stats <- tibble()  # empty tibble for storage

for(do_region in unique(measles_data$region)){
  
  cases <- measles_data %>%
    filter(region == do_region) %>%
    pull(cases)
  
  city_stats <- spaero::get_stats(
    x = cases,
    center_trend = "local_constant", 
    center_kernel = "uniform", 
    center_bandwidth = 35, 
    stat_trend = "local_constant", 
    stat_kernel = "uniform", 
    stat_bandwidth = 35, 
    lag = 1, 
    backward_only = TRUE
  )$stats
  
  city_stats_tb <- as_tibble(city_stats) %>%
    mutate(
      time_iter = 1:n(),
      date = unique(measles_data$date)
    ) %>%
    gather(key = ews, value = value, -time_iter, -date) %>%
    mutate(region = do_region)
  
  all_stats <- bind_rows(all_stats, city_stats_tb)
}

```

Define a function to plot the EWS and the observations.

```{r plot-ews-func}
plot_it <- function(dates, cases, ews, lab, title){
  par(mar = c(5,5,2,5))
  plot(dates, cases, type = "l", main = title)
  par(new = T)
  plot(dates, ews, type = "l", col = "red", axes=F, xlab=NA, ylab=NA)
  axis(side = 4)
  mtext(side = 4, line = 3, lab, cex = 0.7)
}
```

### Agadez

```{r agadez, fig.height=8}
do_region <- "Agadez (City)"
dates <- unique(measles_data$date) 
par(mfrow = c(4,3))
for(do_ews in unique(all_stats$ews)){
  cases <- filter(measles_data, region == do_region) %>% pull(cases)
  ews <- filter(all_stats, region == do_region & ews == do_ews) %>% pull(value)
  plot_it(dates, cases, ews, lab = "ews", title = do_ews)
}
```

### Maradi
```{r maradi, fig.height=8}
do_region <- "Maradi (City)"
dates <- unique(measles_data$date) 
par(mfrow = c(4,3))
for(do_ews in unique(all_stats$ews)){
  cases <- filter(measles_data, region == do_region) %>% pull(cases)
  ews <- filter(all_stats, region == do_region & ews == do_ews) %>% pull(value)
  plot_it(dates, cases, ews, lab = "ews", title = do_ews)
}
```

### Niamey
```{r niamey, fig.height=8}
do_region <- "Niamey (City)"
dates <- unique(measles_data$date) 
par(mfrow = c(4,3))
for(do_ews in unique(all_stats$ews)){
  cases <- filter(measles_data, region == do_region) %>% pull(cases)
  ews <- filter(all_stats, region == do_region & ews == do_ews) %>% pull(value)
  plot_it(dates, cases, ews, lab = "ews", title = do_ews)
}
```

### Zinder
```{r zinder, fig.height=8}
do_region <- "Zinder (City)"
dates <- unique(measles_data$date) 
par(mfrow = c(4,3))
for(do_ews in unique(all_stats$ews)){
  cases <- filter(measles_data, region == do_region) %>% pull(cases)
  ews <- filter(all_stats, region == do_region & ews == do_ews) %>% pull(value)
  plot_it(dates, cases, ews, lab = "ews", title = do_ews)
}
```

# Post-outbreak EWS

As the plots above show, most EWS get swamped out by the "memory" of outbreaks.
To try and get around this, I am going to look at EWS after resetting them following outbreaks.
I don't think this is too contrived because real-world early detection systems would have to do the same thing.

## How to ID outbreaks
Following Toby's suggestion, I am going to look at the distribution of outbreak sizes (i.e., cumulative cases in each year).

```{r}
pop_data <- tibble(
  region = c("Agadez (City)", "Maradi (City)", "Niamey (City)", "Zinder (City)"),
  pop = c(118224, 267249, 1027000, 322935)
)

cusum_data <- measles_data %>%
  group_by(region, year) %>%
  summarise(cases = sum(cases)) %>%
  left_join(pop_data)

ggplot(cusum_data, aes(x = cases/pop)) +
  geom_histogram(aes(fill = region))

cusum_cases <- sort(cusum_data$cases / cusum_data$pop)
fit1 <- MASS::fitdistr(cusum_cases, "exponential") 

x <- cusum_cases
mixexplik <- function(p,lambda1,lambda2) {
  z <- p*dexp(x,lambda1) + (1-p)*dexp(x,lambda2)
  return(-sum(log(z)))
}

mle_fit <- stats4::mle(minuslogl=mixexplik, 
                       start= list(p=0.2,
                                   lambda1 = as.numeric(fit1$estimate), 
                                   lambda2 = as.numeric(fit1$estimate)), 
                       method="Nelder-Mead")

z1 <- rexp(1000, rate = mle_fit@coef["lambda1"])
z2 <- rexp(1000, rate = mle_fit@coef["lambda2"])
zall <- mle_fit@coef["p"]*z1 + (1-mle_fit@coef["p"])*z2

bound <- qexp(p=0.5, rate = mle_fit@coef["lambda1"], lower.tail = TRUE, log.p = FALSE)

hist(x, breaks = 30, freq = FALSE, main = NULL, ylim = c(0,1300),
     xlab = "incidence (reports/person)", col = "grey")
lines(density(z1), col = "red", lwd = 1)
lines(density(z2), col = "blue", lwd = 1)
lines(density(zall), col = "black", lwd = 2)
abline(v = bound, lty = 2, col = "grey25", lwd = 2)
legend(0.0025, 800, legend=c("small outbreaks", "large outbreaks"),
       col=c("red", "blue"), lty = 1, cex = 0.8, lwd = 2)

```


